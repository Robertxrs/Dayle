<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dayle - Seu Organizador Pessoal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .page { display: none; }
        .page.active { display: block; }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        @media (max-width: 768px) {
            #menu-container {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                height: 100vh;
            }
            #menu-container.menu-open {
                transform: translateX(0);
            }
            main {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
        }
    </style>
</head>
<body class="bg-slate-100">

    <div class="flex h-screen relative overflow-hidden">
        <aside class="w-64 bg-slate-800 text-white flex flex-col flex-shrink-0" id="menu-container">
            <button id="close-menu-btn" class="absolute top-4 right-4 text-slate-400 hover:text-white md:hidden z-10" aria-label="Fechar menu">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <div class="p-6 flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
                <h1 class="text-xl font-bold">Dayle</h1>
            </div>
            <nav class="flex-1 px-4 space-y-2 overflow-y-auto" id="nav-menu">
                <a href="#dashboard" class="nav-link bg-indigo-600 text-white flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-indigo-500">
                    <span>Painel</span>
                </a>
                <a href="#day" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>Dia</span>
                </a>
                <a href="#week" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>Semana</span>
                </a>
                <a href="#month" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>Mês</span>
                </a>
                <a href="#finance" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>Finanças</span>
                </a>
                <a href="#buy" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>Compras</span>
                </a>
                <a href="#todo" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>A Fazer</span>
                </a>
                <a href="#goals" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>Metas</span>
                </a>
            </nav>
            <div class="mt-auto p-4 border-t border-slate-700" id="menu-perfil">
                <div id="profile-info" class="text-xs text-slate-400 mb-2 text-center truncate">Carregando...</div>
                <div class="space-y-2">
                    <button id="auth-login-btn" class="w-full text-center bg-slate-700 text-slate-300 text-sm py-1.5 rounded hover:bg-slate-600 transition">Login</button>
                    <button id="auth-signup-btn" class="w-full text-center bg-indigo-600 text-white text-sm py-1.5 rounded hover:bg-indigo-700 transition">Cadastro</button>
                    <button id="auth-logout-btn" class="w-full text-center bg-red-800/50 text-red-300 text-sm py-1.5 rounded hover:bg-red-800/80 transition hidden">Sair</button>
                </div>
            </div>
        </aside>

        <div id="menu-overlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>
        
        <main class="flex-1 p-4 sm:p-8 overflow-y-auto w-full">
            <div class="md:hidden flex items-center mb-6">
                 <button id="open-menu-btn" class="text-slate-800 p-2 -ml-2" aria-label="Abrir menu">
                     <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg>
                 </button>
                 <h2 class="text-xl font-bold text-slate-800 ml-4">Dayle</h2>
            </div>
            
            <section id="dashboard" class="page">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">Painel de Controle</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-slate-500 font-medium">Tarefas Restantes Hoje</h3>
                        <p id="db-tasks" class="text-4xl font-bold text-indigo-600 mt-2">...</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-slate-500 font-medium">Saldo Financeiro</h3>
                        <p id="db-balance" class="text-4xl font-bold text-emerald-500 mt-2">...</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-slate-500 font-medium">Metas em Andamento</h3>
                        <p id="db-goals" class="text-4xl font-bold text-amber-500 mt-2">...</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-slate-500 font-medium">Próximos Itens (Compras)</h3>
                        <ul id="db-shopping" class="mt-2 space-y-1 text-slate-700"></ul>
                    </div>
                </div>
                <div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-slate-700 mb-4">Progresso Geral das Metas</h3>
                    <div id="db-goals-progress" class="space-y-4"></div>
                </div>
            </section>
            
            <section id="day" class="page">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-slate-800">📅 Visão do Dia</h2>
                    <button id="add-day-task-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Adicionar Tarefa</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-semibold text-slate-700 mb-4">Agenda Diária</h3>
                        <ul id="day-tasks-list" class="space-y-3"></ul>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-xl font-semibold text-slate-700">Destaques do Dia</h3>
                                <button id="add-highlight-btn" class="bg-amber-500 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-amber-600 transition">Adicionar</button>
                            </div>
                            <ul id="highlights-list" class="space-y-2"></ul>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-xl font-semibold text-slate-700 mb-3">Bloco de Notas</h3>
                            <textarea id="notepad" class="w-full h-32 p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Anote suas ideias aqui..."></textarea>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="week" class="page">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">📆 Visão da Semana</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-slate-700">Objetivos da Semana</h3>
                            <button id="add-week-goal-btn" class="bg-indigo-600 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-indigo-700 transition">Adicionar</button>
                        </div>
                        <ul id="week-goals-list" class="space-y-2 list-disc list-inside text-slate-700"></ul>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-slate-700">Checklist de Hábitos</h3>
                            <button id="add-habit-btn" class="bg-indigo-600 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-indigo-700 transition">Adicionar</button>
                        </div>
                        <ul id="habits-list" class="space-y-3"></ul>
                    </div>
                </div>
            </section>

            <section id="month" class="page">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">📅 Visão do Mês</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-semibold text-slate-700 mb-4">Calendário</h3>
                        <div class="grid grid-cols-7 gap-1 text-center" id="calendar-grid"></div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-xl font-semibold text-slate-700">Resumo de Conquistas</h3>
                                <button id="add-achievement-btn" class="bg-indigo-600 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-indigo-700 transition">Adicionar</button>
                            </div>
                            <ul id="achievements-list" class="space-y-2 list-disc list-inside text-slate-600"></ul>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-xl font-semibold text-slate-700 mb-2">Produtividade</h3>
                            <p id="month-tasks-completed" class="text-4xl font-bold text-indigo-600">0</p>
                            <p class="text-slate-500">tarefas concluídas este mês.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="finance" class="page">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-slate-800">💰 Finanças</h2>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button id="add-expense-btn" class="w-1/2 sm:w-auto bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition">Nova Despesa</button>
                        <button id="add-income-btn" class="w-1/2 sm:w-auto bg-emerald-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-emerald-600 transition">Nova Receita</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-xl font-semibold text-slate-700 mb-4">Últimas Transações</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left min-w-[500px]">
                                    <thead>
                                        <tr class="border-b">
                                            <th class="py-2">Descrição</th>
                                            <th class="py-2">Categoria</th>
                                            <th class="py-2 text-right">Valor</th>
                                            <th class="py-2 text-center">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactions-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-xl font-semibold text-slate-700 mb-4">Gastos por Categoria</h3>
                            <canvas id="expensesChart"></canvas>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-slate-500 font-medium">Saldo Atual</h3>
                            <p id="finance-balance" class="text-4xl font-bold text-emerald-500 mt-2">R$ 0,00</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-slate-500 font-medium">Projeção para o Mês</h3>
                            <p class="text-3xl font-bold text-sky-500 mt-2">~ R$ 0,00</p>
                            <p class="text-slate-500 mt-1">saldo restante estimado</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="buy" class="page">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">🛒 Lista de Compras</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-slate-700">Mercado</h3>
                            <button data-category="mercado" class="add-shopping-item-btn bg-indigo-600 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-indigo-700 transition">Adicionar</button>
                        </div>
                        <ul id="shopping-list-mercado" class="space-y-3"></ul>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-slate-700">Tecnologia</h3>
                            <button data-category="tecnologia" class="add-shopping-item-btn bg-indigo-600 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-indigo-700 transition">Adicionar</button>
                        </div>
                        <ul id="shopping-list-tecnologia" class="space-y-3"></ul>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-slate-700">Lazer</h3>
                            <button data-category="lazer" class="add-shopping-item-btn bg-indigo-600 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-indigo-700 transition">Adicionar</button>
                        </div>
                        <ul id="shopping-list-lazer" class="space-y-3"></ul>
                    </div>
                </div>
            </section>

            <section id="todo" class="page">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-slate-800">✅ A Fazer</h2>
                    <button id="add-todo-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Adicionar Tarefa</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm overflow-x-auto">
                    <table class="w-full text-left min-w-[600px]">
                        <thead>
                            <tr class="border-b">
                                <th class="py-2 w-1/2">Tarefa</th>
                                <th class="py-2">Prioridade</th>
                                <th class="py-2">Status</th>
                                <th class="py-2 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="todo-table-body"></tbody>
                    </table>
                </div>
            </section>

            <section id="goals" class="page">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-slate-800">🎯 Metas</h2>
                    <button id="add-goal-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Adicionar Meta</button>
                </div>
                <div id="goals-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </section>
        </main>
    </div>

    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div id="modal-backdrop" class="fixed inset-0 modal-backdrop opacity-0" style="transition: opacity 0.3s ease;"></div>
        <div id="modal-content" class="relative bg-white rounded-lg shadow-xl w-full max-w-md m-4 p-6 modal-content opacity-0 scale-95" style="transition: all 0.3s ease;">
            <h3 id="modal-title" class="text-2xl font-bold text-slate-800 mb-4"></h3>
            <p id="modal-message" class="text-slate-600 my-4 hidden"></p>
            <form id="modal-form" class="space-y-4"></form>
            <div id="modal-buttons" class="mt-6 flex justify-end gap-3"></div>
            <button id="modal-close" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600" aria-label="Fechar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // ===================================================================
    // 1. CONFIGURAÇÃO E UTILS
    // ===================================================================
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);
    const formatCurrency = (value) => (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    const SUPABASE_URL = 'https://xbdvqegxtjyygibheikm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhiZHZxZWd4dGp5eWdpYmhlaWttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MDk4NzEsImV4cCI6MjA3NDM4NTg3MX0.GJrkOw6CyduBcNGXepqKN7ybauBKjv5PZ98s2L4zZ9I';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===================================================================
    // 2. LÓGICA DO MENU RESPONSIVO
    // ===================================================================
    const menuContainer = $('#menu-container');
    const openMenuBtn = $('#open-menu-btn');
    const closeMenuBtn = $('#close-menu-btn');
    const menuOverlay = $('#menu-overlay');

    function toggleMenu(show) {
        menuContainer.classList.toggle('menu-open', show);
        menuOverlay.classList.toggle('hidden', !show);
    }

    // ===================================================================
    // 3. ESTADO DA APLICAÇÃO E LÓGICA DE AUTENTICAÇÃO
    // ===================================================================
    let state = {};
    let currentProfileId = null;

    async function refreshDataAndRender() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        const profileInfoDiv = $('#profile-info');
        const loginBtn = $('#auth-login-btn');
        const signupBtn = $('#auth-signup-btn');
        const logoutBtn = $('#auth-logout-btn');

        if (session?.user) {
            currentProfileId = session.user.id;
            if(profileInfoDiv) profileInfoDiv.textContent = `Logado como: ${session.user.email}`;
            loginBtn.classList.add('hidden');
            signupBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            await loadAllProfileData(currentProfileId);
        } else {
            currentProfileId = null;
            if(profileInfoDiv) profileInfoDiv.textContent = 'Nenhum usuário logado.';
            loginBtn.classList.remove('hidden');
            signupBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            state = {
                dayTasks: [], dayHighlights: [], notepadContent: '', weekGoals: [], habits: [],
                monthAchievements: [], transactions: [], shoppingList: [], todos: [], goals: [],
            };
        }
        renderAll();
    }
    
    async function loadAllProfileData(profileId) {
        const queries = [
            supabaseClient.from('day_tasks').select('*').eq('profile_id', profileId),
            supabaseClient.from('day_highlights').select('*').eq('profile_id', profileId),
            supabaseClient.from('notepad').select('content').eq('profile_id', profileId).maybeSingle(),
            supabaseClient.from('week_goals').select('*').eq('profile_id', profileId),
            supabaseClient.from('habits').select('*').eq('profile_id', profileId),
            supabaseClient.from('month_achievements').select('*').eq('profile_id', profileId),
            supabaseClient.from('transactions').select('*').eq('profile_id', profileId),
            supabaseClient.from('shopping_list').select('*').eq('profile_id', profileId),
            supabaseClient.from('todos').select('*').eq('profile_id', profileId),
            supabaseClient.from('goals').select('*').eq('profile_id', profileId),
        ];
        try {
            const results = await Promise.all(queries);
            const [
                dayTasks, dayHighlights, notepad, weekGoals, habits, 
                monthAchievements, transactions, shoppingList, todos, goals
            ] = results.map(res => res.data);
            
            state = {
                dayTasks: dayTasks || [], dayHighlights: dayHighlights || [], notepadContent: notepad?.content || '',
                weekGoals: weekGoals || [], habits: habits || [], monthAchievements: monthAchievements || [],
                transactions: transactions || [], shoppingList: shoppingList || [], todos: todos || [], goals: goals || [],
            };
        } catch (error) {
            console.error("Erro ao carregar dados do perfil:", error);
            showAlert(`Erro ao carregar dados: ${error.message}`);
        }
    }

    async function signUp(email, password) {
        const { error } = await supabaseClient.auth.signUp({ email, password });
        if (error) {
            showAlert(`Erro no cadastro: ${error.message}`);
        } else {
            showAlert('Cadastro realizado! Por favor, faça o login para continuar.');
            closeModal();
        }
    }

    async function signIn(email, password) {
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) {
            showAlert(`Erro no login: ${error.message}`);
        } else {
            closeModal();
        }
    }

    async function signOut() {
        const { error } = await supabaseClient.auth.signOut();
        if (error) showAlert(`Erro ao sair: ${error.message}`);
    }

    // ===================================================================
    // 4. LÓGICA DO MODAL PERSONALIZADO
    // ===================================================================
    const modal = $('#modal');
    const modalBackdrop = $('#modal-backdrop');
    const modalContent = $('#modal-content');
    const modalTitle = $('#modal-title');
    const modalMessage = $('#modal-message');
    const modalForm = $('#modal-form');
    const modalButtons = $('#modal-buttons');
    const modalCloseBtn = $('#modal-close');

    function openModal({title, formHtml = '', message = '', buttonsHtml = ''}) {
        modalTitle.textContent = title;
        modalForm.innerHTML = formHtml;
        modalButtons.innerHTML = buttonsHtml;
        modalMessage.textContent = message;
        modalMessage.classList.toggle('hidden', !message);
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            modalBackdrop.classList.remove('opacity-0');
            modalContent.classList.remove('opacity-0', 'scale-95');
        }, 10);
    }
    
    function closeModal() {
        modalBackdrop.classList.add('opacity-0');
        modalContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modalForm.innerHTML = '';
            modalButtons.innerHTML = '';
            modalMessage.innerHTML = '';
        }, 300);
    }
    
    function showAlert(message) {
        openModal({
            title: 'Aviso',
            message: message,
            buttonsHtml: `<button id="modal-ok" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">OK</button>`
        });
        $('#modal-ok').addEventListener('click', closeModal);
    }

    function showAuthModal(type) {
        const isLogin = type === 'login';
        openModal({
            title: isLogin ? 'Login' : 'Cadastro',
            formHtml: `
                <input type="email" id="auth-email" placeholder="Login" class="w-full p-2 border rounded" autocomplete="email">
                <input type="password" id="auth-password" placeholder="Sua senha" class="w-full p-2 border rounded" autocomplete="current-password">
            `,
            buttonsHtml: `
                <button id="modal-cancel-auth" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button id="modal-confirm-auth" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">${isLogin ? 'Entrar' : 'Cadastrar'}</button>
            `
        });

        $('#modal-cancel-auth').addEventListener('click', closeModal);
        $('#modal-confirm-auth').addEventListener('click', () => {
            const email = $('#auth-email').value;
            const password = $('#auth-password').value;
            if (isLogin) signIn(email, password);
            else signUp(email, password);
        });
    }
    
    function openCrudModal(options) {
        openModal({
            title: options.title,
            formHtml: options.formHtml,
            buttonsHtml: `
                <button id="modal-cancel-form" class="px-4 py-2 bg-slate-200 rounded-lg">Cancelar</button>
                <button id="modal-save-form" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Salvar</button>
            `
        });
        $('#modal-cancel-form').onclick = closeModal;
        $('#modal-save-form').onclick = () => {
            const formData = new FormData(modalForm);
            const data = {};
            for(let [key, value] of formData.entries()) {
                const input = modalForm.querySelector(`[name="${key}"]`);
                if(input.type === 'number') data[key] = parseFloat(value) || 0;
                else if (input.type === 'checkbox') data[key] = input.checked;
                else data[key] = value;
            }
            options.onSave(data);
        };
    }

    // ===================================================================
    // 5. NAVEGAÇÃO ENTRE PÁGINAS
    // ===================================================================
    const navLinks = $$('.nav-link');
    const pages = $$('.page');
    const navMenu = $('#nav-menu');
    let expensesChartInstance = null;
    
    function showPage(targetId) {
        navLinks.forEach(link => {
            link.classList.toggle('bg-indigo-600', link.getAttribute('href') === targetId);
            link.classList.toggle('text-white', link.getAttribute('href') === targetId);
            link.classList.toggle('text-slate-300', link.getAttribute('href') !== targetId);
        });
        pages.forEach(page => page.classList.toggle('active', `#${page.id}` === targetId));
        window.history.pushState(null, '', targetId);
        if (targetId === '#finance' && currentProfileId) renderExpensesChart();
        if (targetId === '#dashboard' && currentProfileId) updateDashboard();
    }

    // ===================================================================
    // 6. FUNÇÕES DE RENDERIZAÇÃO
    // ===================================================================
    function renderAll() {
        updateDashboard(); renderDayTasks(); renderDayHighlights(); renderNotepad(); 
        renderWeekGoals(); renderHabits(); renderMonthAchievements(); renderTransactions();
        renderShoppingList(); renderTodos(); renderGoals(); renderCalendar();
    }
    function updateDashboard() {
        if(!state.dayTasks || !state.transactions || !state.goals || !state.shoppingList) return;
        const pendingTasks = state.dayTasks.filter(t => !t.completed).length;
        const totalTasks = state.dayTasks.length;
        $('#db-tasks').innerHTML = `${pendingTasks} <span class="text-2xl text-slate-400 font-medium">/ ${totalTasks}</span>`;
        const balance = state.transactions.reduce((acc, t) => acc + (t.type === 'income' ? Number(t.amount) : -Number(t.amount)), 0);
        $('#db-balance').textContent = formatCurrency(balance);
        const goalsInProgress = state.goals.filter(g => g.current < g.target).length;
        $('#db-goals').textContent = goalsInProgress;
        const shoppingItems = state.shoppingList.filter(i => !i.completed).slice(0, 3);
        $('#db-shopping').innerHTML = shoppingItems.map(i => `<li>- ${i.text}</li>`).join('') || '<li class="text-slate-400">Nenhum item.</li>';
        $('#db-goals-progress').innerHTML = state.goals.map(goal => {
            const percentage = goal.target > 0 ? Math.round((goal.current / goal.target) * 100) : 0;
            return `<div><div class="flex justify-between mb-1"><span class="text-slate-700 text-sm">${goal.text}</span><span class="text-slate-500 text-sm">${percentage}%</span></div><div class="w-full bg-slate-200 rounded-full h-2"><div class="bg-indigo-600 h-2 rounded-full" style="width: ${percentage}%"></div></div></div>`;
        }).join('');
    }
    function renderDayTasks() {
        const list = $('#day-tasks-list');
        if (!state.dayTasks) { list.innerHTML = ''; return; }
        list.innerHTML = state.dayTasks.map(task => `<li class="flex items-center justify-between group"><div class="flex items-center"><input type="checkbox" data-id="${task.id}" class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-slate-300 day-task-check" ${task.completed ? 'checked' : ''}> <span class="ml-3 ${task.completed ? 'text-slate-500 line-through' : 'text-slate-800'}">${task.text}</span></div><div class="hidden group-hover:flex gap-2"><button data-id="${task.id}" class="delete-day-task-btn text-slate-400 hover:text-red-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></li>`).join('');
    }
    function renderDayHighlights() {
        const list = $('#highlights-list');
        if (!state.dayHighlights) { list.innerHTML = ''; return; }
        list.innerHTML = state.dayHighlights.map(highlight => `<li class="group flex justify-between items-center bg-amber-100 text-amber-800 p-3 rounded-md"><span class="break-all">${highlight.text}</span><div class="hidden group-hover:flex gap-2 flex-shrink-0 ml-2"><button data-id="${highlight.id}" class="delete-highlight-btn text-amber-700 hover:text-red-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></li>`).join('');
    }
    function renderNotepad() { $('#notepad').value = state.notepadContent || ''; }
    function renderWeekGoals() {
        const list = $('#week-goals-list');
        if (!state.weekGoals) { list.innerHTML = ''; return; }
        list.innerHTML = state.weekGoals.map(goal => `<li class="flex justify-between items-center group"><span>${goal.text}</span><div class="hidden group-hover:flex gap-2"><button data-id="${goal.id}" class="delete-week-goal-btn text-slate-400 hover:text-red-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></li>`).join('');
    }
    function renderHabits() {
        const list = $('#habits-list');
        if (!state.habits) { list.innerHTML = ''; return; }
        list.innerHTML = state.habits.map(habit => `<li class="flex items-center justify-between group"><div class="flex items-center"><input type="checkbox" data-id="${habit.id}" class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-slate-300 habit-check" ${habit.completed ? 'checked' : ''}><span class="ml-3 ${habit.completed ? 'text-slate-500 line-through' : 'text-slate-800'}">${habit.text}</span></div><div class="hidden group-hover:flex gap-2"><button data-id="${habit.id}" class="delete-habit-btn text-slate-400 hover:text-red-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></li>`).join('');
    }
    function renderMonthAchievements() {
        const list = $('#achievements-list');
        if (!state.monthAchievements) { list.innerHTML = ''; return; }
        list.innerHTML = state.monthAchievements.map(achievement => `<li class="group flex justify-between items-center"><span>${achievement.text}</span><div class="hidden group-hover:flex gap-2"><button data-id="${achievement.id}" class="delete-achievement-btn text-slate-400 hover:text-red-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></li>`).join('');
    }
    function renderCalendar() {
        const grid = $('#calendar-grid');
        const days = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SAB'];
        grid.innerHTML = days.map(d => `<div class="font-semibold text-slate-500 text-sm">${d}</div>`).join('');
        const today = new Date().getDate();
        for (let i = 1; i <= 30; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'p-2 rounded-md';
            dayEl.textContent = i;
            if (i === today) dayEl.classList.add('bg-indigo-600', 'text-white', 'font-bold');
            grid.appendChild(dayEl);
        }
    }
    function renderTransactions() {
        const body = $('#transactions-table-body');
        if (!state.transactions) { body.innerHTML = ''; return; }
        body.innerHTML = state.transactions.map(t => `<tr class="border-b"><td class="py-3 px-1">${t.description}</td><td class="px-1">${t.category}</td><td class="text-right px-1 ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}">${t.type === 'income' ? '+' : '-'} ${formatCurrency(t.amount)}</td><td class="text-center px-1"><button data-id="${t.id}" class="delete-transaction-btn text-slate-400 hover:text-red-600 p-1"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></td></tr>`).join('');
        renderExpensesChart();
    }
    function renderExpensesChart() {
        const ctx = document.getElementById('expensesChart');
        if (!ctx) return;
        if (expensesChartInstance) expensesChartInstance.destroy();
        if(!state.transactions) return;
        const expenseData = state.transactions.filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + Number(t.amount); return acc; }, {});
        expensesChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(expenseData), datasets: [{ data: Object.values(expenseData), backgroundColor: ['rgba(79, 70, 229, 0.8)','rgba(245, 158, 11, 0.8)','rgba(14, 165, 233, 0.8)','rgba(239, 68, 68, 0.8)'], borderColor: '#fff' }] }, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
    }
    function renderShoppingList() {
        if(!state.shoppingList) return;
        ['mercado', 'tecnologia', 'lazer'].forEach(category => {
            const list = $(`#shopping-list-${category}`);
            const items = state.shoppingList.filter(item => item.category === category);
            list.innerHTML = items.map(item => `<li class="flex items-center justify-between group"><div class="flex items-center"><input type="checkbox" data-id="${item.id}" class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-slate-300 shopping-item-check" ${item.completed ? 'checked' : ''}><span class="ml-3 ${item.completed ? 'text-slate-500 line-through' : 'text-slate-800'}">${item.text}</span></div><div class="hidden group-hover:flex gap-2"><button data-id="${item.id}" class="delete-shopping-item-btn text-slate-400 hover:text-red-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></li>`).join('');
        });
    }
    function renderTodos() {
        const body = $('#todo-table-body');
        if (!state.todos) { body.innerHTML = ''; return; }
        const priorityMap = { alta: 'bg-red-100 text-red-800', media: 'bg-amber-100 text-amber-800', baixa: 'bg-green-100 text-green-800' };
        const statusMap = { pendente: 'bg-slate-100 text-slate-800', andamento: 'bg-sky-100 text-sky-800', concluido: 'bg-emerald-100 text-emerald-800' };
        body.innerHTML = state.todos.map(todo => `<tr class="border-b"><td class="py-4 px-1 ${todo.status === 'concluido' ? 'line-through text-slate-500' : ''}">${todo.text}</td><td class="px-1"><span class="px-2 py-1 text-xs font-semibold rounded-full ${priorityMap[todo.priority]}">${todo.priority}</span></td><td class="px-1"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusMap[todo.status]}">${todo.status}</span></td><td class="text-center px-1"><button data-id="${todo.id}" class="delete-todo-btn text-slate-400 hover:text-red-600 p-1"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></td></tr>`).join('');
    }
    function renderGoals() {
        const list = $('#goals-list');
        if (!state.goals) { list.innerHTML = ''; return; }
        const categoryColors = { Financeira: 'bg-indigo-600', Saúde: 'bg-emerald-500', Estudos: 'bg-amber-500', Pessoal: 'bg-sky-500' };
        list.innerHTML = state.goals.map(goal => {
            const percentage = goal.target > 0 ? Math.round((goal.current / goal.target) * 100) : 0;
            return `<div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex justify-between items-start"><div><h3 class="text-xl font-semibold text-slate-700">${goal.category}</h3><p class="text-slate-600 mt-1">${goal.text}</p></div><div class="flex gap-2"><button data-id="${goal.id}" class="delete-goal-btn text-slate-400 hover:text-red-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></div><div class="mt-4"><div class="flex justify-between mb-1"><span class="text-slate-700">${goal.unit === 'R$' ? formatCurrency(goal.current) : goal.current} / ${goal.unit === 'R$' ? formatCurrency(goal.target) : goal.target} ${goal.unit !== '%' && goal.unit !== 'R$' ? goal.unit : ''}</span><span class="text-slate-500">${percentage}%</span></div><div class="w-full bg-slate-200 rounded-full h-2.5"><div class="${categoryColors[goal.category] || 'bg-slate-500'} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div></div>`;
        }).join('');
    }
    
    // ===================================================================
    // 7. SETUP DE EVENTOS
    // ===================================================================
    function setupEventListeners() {
        // Menu e Autenticação
        openMenuBtn.addEventListener('click', () => toggleMenu(true));
        closeMenuBtn.addEventListener('click', () => toggleMenu(false));
        menuOverlay.addEventListener('click', () => toggleMenu(false));
        $('#auth-login-btn').addEventListener('click', () => showAuthModal('login'));
        $('#auth-signup-btn').addEventListener('click', () => showAuthModal('signup'));
        $('#auth-logout-btn').addEventListener('click', signOut);

        // Navegação
        navMenu.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link) {
                e.preventDefault();
                showPage(link.getAttribute('href'));
                if (window.innerWidth <= 768) { toggleMenu(false); }
            }
        });
        modalCloseBtn.addEventListener('click', closeModal);

        // Notepad
        $('#notepad').addEventListener('input', async (e) => {
            if (!currentProfileId) return;
            await supabaseClient.from('notepad').upsert({ profile_id: currentProfileId, content: e.target.value });
        });

        // --- CRUDs ---
        setupCrudListeners();
    }

    function setupCrudListeners() {
        // Day Tasks
        $('#add-day-task-btn').addEventListener('click', () => {
            if (!currentProfileId) return showAlert("Faça login para adicionar tarefas.");
            openCrudModal({ title: 'Nova Tarefa do Dia', formHtml: `<input name="text" placeholder="Descrição" class="w-full p-2 border rounded">`,
                onSave: async (data) => {
                    if (!data.text) return;
                    await supabaseClient.from('day_tasks').insert({ text: data.text, profile_id: currentProfileId });
                    closeModal(); await refreshDataAndRender();
                }
            });
        });
        $('#day-tasks-list').addEventListener('click', async (e) => {
            const button = e.target.closest('button, input');
            if (!button?.dataset.id) return;
            const id = button.dataset.id;
            if (button.matches('.delete-day-task-btn')) {
                await supabaseClient.from('day_tasks').delete().eq('id', id);
            } else if (button.matches('.day-task-check')) {
                const task = state.dayTasks.find(t => t.id == id);
                await supabaseClient.from('day_tasks').update({ completed: !task.completed }).eq('id', id);
            }
            await refreshDataAndRender();
        });

        // Day Highlights
        $('#add-highlight-btn').addEventListener('click', () => {
            if (!currentProfileId) return showAlert("Faça login para adicionar destaques.");
            openCrudModal({ title: 'Novo Destaque', formHtml: `<input name="text" placeholder="Destaque do dia" class="w-full p-2 border rounded">`,
                onSave: async (data) => {
                    if(!data.text) return;
                    await supabaseClient.from('day_highlights').insert({ text: data.text, profile_id: currentProfileId });
                    closeModal(); await refreshDataAndRender();
                }
            });
        });
        $('#highlights-list').addEventListener('click', async (e) => {
            const button = e.target.closest('.delete-highlight-btn');
            if (!button?.dataset.id) return;
            await supabaseClient.from('day_highlights').delete().eq('id', button.dataset.id);
            await refreshDataAndRender();
        });

        // Week Goals
        $('#add-week-goal-btn').addEventListener('click', () => {
            if (!currentProfileId) return showAlert("Faça login para adicionar objetivos.");
            openCrudModal({ title: 'Novo Objetivo Semanal', formHtml: `<input name="text" placeholder="Descrição do objetivo" class="w-full p-2 border rounded">`,
                onSave: async (data) => {
                    if(!data.text) return;
                    await supabaseClient.from('week_goals').insert({ text: data.text, profile_id: currentProfileId });
                    closeModal(); await refreshDataAndRender();
                }
            });
        });
        $('#week-goals-list').addEventListener('click', async (e) => {
            const button = e.target.closest('.delete-week-goal-btn');
            if (!button?.dataset.id) return;
            await supabaseClient.from('week_goals').delete().eq('id', button.dataset.id);
            await refreshDataAndRender();
        });

        // Habits
        $('#add-habit-btn').addEventListener('click', () => {
            if (!currentProfileId) return showAlert("Faça login para adicionar hábitos.");
            openCrudModal({ title: 'Novo Hábito', formHtml: `<input name="text" placeholder="Descrição do hábito" class="w-full p-2 border rounded">`,
                onSave: async (data) => {
                    if(!data.text) return;
                    await supabaseClient.from('habits').insert({ text: data.text, profile_id: currentProfileId });
                    closeModal(); await refreshDataAndRender();
                }
            });
        });
        $('#habits-list').addEventListener('click', async (e) => {
            const el = e.target.closest('.delete-habit-btn, .habit-check');
            if (!el?.dataset.id) return;
            const id = el.dataset.id;
            if (el.matches('.delete-habit-btn')) {
                await supabaseClient.from('habits').delete().eq('id', id);
            } else if (el.matches('.habit-check')) {
                const habit = state.habits.find(h => h.id == id);
                await supabaseClient.from('habits').update({ completed: !habit.completed }).eq('id', id);
            }
            await refreshDataAndRender();
        });
        
        // Month Achievements
        $('#add-achievement-btn').addEventListener('click', () => {
            if (!currentProfileId) return showAlert("Faça login para adicionar conquistas.");
            openCrudModal({ title: 'Nova Conquista', formHtml: `<input name="text" placeholder="Descrição da conquista" class="w-full p-2 border rounded">`,
                onSave: async(data) => {
                    if(!data.text) return;
                    await supabaseClient.from('month_achievements').insert({ text: data.text, profile_id: currentProfileId });
                    closeModal(); await refreshDataAndRender();
                }
            });
        });
        $('#achievements-list').addEventListener('click', async (e) => {
            const button = e.target.closest('.delete-achievement-btn');
            if (!button?.dataset.id) return;
            await supabaseClient.from('month_achievements').delete().eq('id', button.dataset.id);
            await refreshDataAndRender();
        });

        // Finance
        const transactionFormHtml = (type) => `<input type="text" name="description" placeholder="Descrição" class="w-full p-2 border rounded"><input type="text" name="category" placeholder="Categoria" class="w-full p-2 border rounded"><input type="number" name="amount" placeholder="Valor" step="0.01" class="w-full p-2 border rounded"><input type="hidden" name="type" value="${type}">`;
        $('#add-income-btn').addEventListener('click', () => {
            if (!currentProfileId) return showAlert("Faça login para adicionar transações.");
            openCrudModal({ title: 'Nova Receita', formHtml: transactionFormHtml('income'),
                onSave: async (data) => {
                    if(!data.description || !data.amount) return;
                    await supabaseClient.from('transactions').insert({ ...data, profile_id: currentProfileId });
                    closeModal(); await refreshDataAndRender();
                }
            });
        });
        $('#add-expense-btn').addEventListener('click', () => {
            if (!currentProfileId) return showAlert("Faça login para adicionar transações.");
            openCrudModal({ title: 'Nova Despesa', formHtml: transactionFormHtml('expense'),
                onSave: async (data) => {
                    if(!data.description || !data.amount) return;
                    await supabaseClient.from('transactions').insert({ ...data, profile_id: currentProfileId });
                    closeModal(); await refreshDataAndRender();
                }
            });
        });
        $('#transactions-table-body').addEventListener('click', async (e) => {
            const button = e.target.closest('.delete-transaction-btn');
            if (!button?.dataset.id) return;
            await supabaseClient.from('transactions').delete().eq('id', button.dataset.id);
            await refreshDataAndRender();
        });
        
        // Shopping
        $$('.add-shopping-item-btn').forEach(btn => btn.addEventListener('click', (e) => {
            if (!currentProfileId) return showAlert("Faça login para adicionar itens.");
            const category = e.target.dataset.category;
            openCrudModal({ title: `Novo Item - ${category}`, formHtml: `<input name="text" placeholder="Nome do item" class="w-full p-2 border rounded">`,
                onSave: async (data) => {
                    if(!data.text) return;
                    await supabaseClient.from('shopping_list').insert({ ...data, category, profile_id: currentProfileId });
                    closeModal(); await refreshDataAndRender();
                }
            });
        }));
        $('#buy').addEventListener('click', async (e) => {
            const el = e.target.closest('.delete-shopping-item-btn, .shopping-item-check');
            if (!el?.dataset.id) return;
            const id = el.dataset.id;
            if (el.matches('.delete-shopping-item-btn')) {
                await supabaseClient.from('shopping_list').delete().eq('id', id);
            } else if (el.matches('.shopping-item-check')) {
                const item = state.shoppingList.find(i => i.id == id);
                await supabaseClient.from('shopping_list').update({ completed: !item.completed }).eq('id', id);
            }
            await refreshDataAndRender();
        });

        // To-Do
        const todoFormHtml = `<input type="text" name="text" placeholder="Descrição da tarefa" class="w-full p-2 border rounded"><select name="priority" class="w-full p-2 border rounded"><option value="baixa">Baixa</option><option value="media">Média</option><option value="alta">Alta</option></select><select name="status" class="w-full p-2 border rounded"><option value="pendente">Pendente</option><option value="andamento">Em Andamento</option><option value="concluido">Concluído</option></select>`;
        $('#add-todo-btn').addEventListener('click', () => {
            if (!currentProfileId) return showAlert("Faça login para adicionar tarefas.");
            openCrudModal({ title: 'Nova Tarefa', formHtml: todoFormHtml,
                onSave: async (data) => {
                    if(!data.text) return;
                    await supabaseClient.from('todos').insert({ ...data, profile_id: currentProfileId });
                    closeModal(); await refreshDataAndRender();
                }
            });
        });
        $('#todo-table-body').addEventListener('click', async (e) => {
            const button = e.target.closest('.delete-todo-btn');
            if (!button?.dataset.id) return;
            await supabaseClient.from('todos').delete().eq('id', button.dataset.id);
            await refreshDataAndRender();
        });
        
        // Goals
        const goalFormHtml = `<input type="text" name="text" placeholder="Descrição da meta" class="w-full p-2 border rounded"><select name="category" class="w-full p-2 border rounded"><option>Financeira</option><option>Saúde</option><option>Estudos</option><option>Pessoal</option></select><input type="number" name="current" placeholder="Valor Atual" class="w-full p-2 border rounded" step="any"><input type="number" name="target" placeholder="Valor Alvo" class="w-full p-2 border rounded" step="any"><input type="text" name="unit" placeholder="Unidade (ex: R$, km, %)" class="w-full p-2 border rounded">`;
        $('#add-goal-btn').addEventListener('click', () => {
            if (!currentProfileId) return showAlert("Faça login para adicionar metas.");
            openCrudModal({ title: 'Nova Meta', formHtml: goalFormHtml,
                onSave: async (data) => {
                    if(!data.text || !data.target) return;
                    await supabaseClient.from('goals').insert({ ...data, profile_id: currentProfileId });
                    closeModal(); await refreshDataAndRender();
                }
            });
        });
        $('#goals-list').addEventListener('click', async (e) => {
            const button = e.target.closest('.delete-goal-btn');
            if (!button?.dataset.id) return;
            await supabaseClient.from('goals').delete().eq('id', button.dataset.id);
            await refreshDataAndRender();
        });
    }

    // ===================================================================
    // 8. INICIALIZAÇÃO DA APLICAÇÃO
    // ===================================================================
    supabaseClient.auth.onAuthStateChange(() => {
        refreshDataAndRender();
    });

    setupEventListeners();
    await refreshDataAndRender(); 
    const initialHash = window.location.hash || '#dashboard';
    showPage(initialHash);
});
</script>
</body>
</html>