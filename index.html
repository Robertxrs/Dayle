<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dale - Seu Organizador Pessoal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
    <link rel="icon" type="image/x-icon" href="cabbage_vegetables_vegetable_food_agriculture_icon_220811.ico">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .page { display: none; }
        .page.active { display: block; }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        

        .day-cell {
            cursor: pointer;
            transition: transform 0.2s;
            border-radius: 8px;
        }


        .day-cell:hover {
            background-color: #eef2ff;
        }
        .day-cell.has-reminder {
            background-color: #fecaca;
            font-weight: bold;
            color: #991b1b;
            position: relative;
        }
        .day-cell.is-today {
            background-color: #4f46e5;
            color: white;
        }
        .day-cell.is-today:hover {
            background-color: #4338ca; 
        }


        #menu-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #nav-menu {
            overflow-y: auto;
            flex-grow: 1;
        }
        .progress-bar-container {
            position: relative;
            cursor: pointer;
            padding: 8px 0;
            margin-top: -8px;
            margin-bottom: -8px;
        }
        .progress-handle {
            position: absolute;
            top: 50%;
            width: 18px;
            height: 18px;
            background-color: white;
            border: 4px solid #4f46e5;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
            transition: transform 0.1s ease;
        }
        .progress-bar-container:hover .progress-handle {
            transform: translate(-50%, -50%) scale(1.15);
        }
        .note-group-header {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background-color: #f1f5f9;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #334155;
            position: relative;

        }
        .note-group-header .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
        }
        .note-group-header .arrow {
            margin-left: auto;
            transition: transform 0.2s;
        }
        .note-group-header.collapsed .arrow {
            transform: rotate(-90deg);
        }
        .note-group-content {
            padding-left: 20px;
            border-left: 2px solid #e2e8f0;
            margin-left: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
        }

        .note-group-content.collapsed {
            display: none;
        }
        .color-circle-wrapper {
            position: relative;
        }
        .color-circle {
            display: block;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        .color-circle-wrapper input:checked + .color-circle {
            border-color: #fff;
            box-shadow: 0 0 0 2px #4f46e5;
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 0;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .collapsible-header .arrow {
            transition: transform 0.2s;
            color: #64748b;
        }
        .collapsible-header.collapsed .arrow {
            transform: rotate(-90deg);
        }
        [data-collapsible-content].collapsed {
            display: none;
        }
        #menu-container.menu-open + #swipe-handle {
                    left: -20px;
                    opacity: 0;
                }
        main.flex-1{
            padding-top: 3rem;
        }
        @media (max-width: 768px) {
            #menu-container {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            #menu-container.menu-open {
                transform: translateX(0);
            }
            main {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
             #mobile-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 40;
            }
            main > .md\:hidden {
                margin-bottom: 0;
            }
            main {
                padding-top: 5.5rem; 
            }    
            #swipe-handle {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 110px;
            background-color: rgba(79, 70, 229, 0.5);
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            animation: pulse-glow 2s infinite ease-in-out;
        }
        main.flex-1 {
            padding-top: 9rem;
        }
        }
        
        @keyframes pulse-glow {
            0% {
                background-color: rgba(79, 70, 229, 0.5);
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            50% {
                background-color: rgba(99, 102, 241, 0.7); 
                box-shadow: 3px 0 15px rgba(99, 102, 241, 0.3);
            }
            100% {
                background-color: rgba(79, 70, 229, 0.5);
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
        }
        
    </style>
</head>
<body class="bg-slate-100">

    <div id="swipe-handle" class="md:hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
    </div>
    <div  class="flex h-screen relative overflow-hidden">
        <aside class="w-64 bg-slate-800 text-white flex flex-col flex-shrink-0" id="menu-container">
            <button id="close-menu-btn" class="absolute top-4 right-4 text-slate-400 hover:text-white md:hidden z-10" aria-label="Fechar menu">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <div class="p-6 flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
                <h1 class="text-xl font-bold">Dale</h1>
            </div>
            <nav class="flex-1 px-4 space-y-2 overflow-y-auto" id="nav-menu">
                <a href="#dashboard" class="nav-link bg-indigo-600 text-white flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-indigo-500">
                    <span>Painel</span>
                </a>
                <a href="#day" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>Dia</span>
                </a>
                <a href="#week" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>Semana</span>
                </a>
                <a href="#month" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>M√™s</span>
                </a>
                <a href="#finance" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>Finan√ßas</span>
                </a>
                <a href="#buy" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>Compras</span>
                </a>
                <a href="#todo" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>A Fazer</span>
                </a>
                <a href="#goals" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>Metas</span>
                </a>
                <a href="#notes" class="nav-link text-slate-300 flex items-center gap-3 px-4 py-2 rounded-lg transition-colors hover:bg-slate-700">
                    <span>Bloco de Notas</span>
                </a>
            </nav>
            <div class="mt-auto p-4 border-t border-slate-700" id="menu-perfil">
                <div id="profile-info" class="text-xs text-slate-400 mb-2 text-center truncate">Carregando...</div>
                <div class="space-y-2">
                    <button id="auth-login-btn" class="w-full text-center bg-slate-700 text-slate-300 text-sm py-1.5 rounded hover:bg-slate-600 transition">Login</button>
                    <button id="auth-signup-btn" class="w-full text-center bg-indigo-600 text-white text-sm py-1.5 rounded hover:bg-indigo-700 transition">Cadastro</button>
                    <button id="auth-logout-btn" class="w-full text-center bg-red-800/50 text-red-300 text-sm py-1.5 rounded hover:bg-red-800/80 transition hidden">Sair</button>
                </div>
            </div>
        </aside>


        <div id="menu-overlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>
       
        <main class="flex-1 p-4 sm:p-8 overflow-y-auto w-full">
            <header id="mobile-header" class="md:hidden flex items-center p-4 bg-slate-100 border-b border-slate-200">
                 <button id="open-menu-btn" class="text-slate-800 p-2 -ml-2" aria-label="Abrir menu">
                     <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg>
                 </button>
                 <h2 class="text-xl font-bold text-slate-800 ml-4">Dale</h2>
                 
                 <button id="install-pwa-btn" class="text-slate-800 p-2 ml-auto hidden" aria-label="Instalar aplicativo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                 </button>
            </header>
           
            <section id="dashboard" class="page">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">Painel de Controle</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    
                    <div data-target-page="#day" class="bg-white p-6 rounded-lg shadow-sm cursor-pointer hover:shadow-lg hover:scale-105 transition-transform">
                        <h3 class="text-slate-500 font-medium">Tarefas Restantes Hoje</h3>
                        <p id="db-tasks" class="text-4xl font-bold text-indigo-600 mt-2">...</p>
                    </div>

                    <div data-target-page="#finance" class="bg-white p-6 rounded-lg shadow-sm cursor-pointer hover:shadow-lg hover:scale-105 transition-transform">
                        <h3 class="text-slate-500 font-medium">Saldo Financeiro</h3>
                        <p id="db-balance" class="text-4xl font-bold text-emerald-500 mt-2">...</p>
                    </div>

                    <div data-target-page="#goals" class="bg-white p-6 rounded-lg shadow-sm cursor-pointer hover:shadow-lg hover:scale-105 transition-transform">
                        <h3 class="text-slate-500 font-medium">Metas em Andamento</h3>
                        <p id="db-goals" class="text-4xl font-bold text-amber-500 mt-2">...</p>
                    </div>

                    <div data-target-page="#buy" class="bg-white p-6 rounded-lg shadow-sm cursor-pointer hover:shadow-lg hover:scale-105 transition-transform">
                        <h3 class="text-slate-500 font-medium">Pr√≥ximos Itens (Compras)</h3>
                        <ul id="db-shopping" class="mt-2 space-y-1 text-slate-700"></ul>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm col-span-1 md:col-span-2 lg:col-span-4">
                        <h3 class="text-slate-500 font-medium">Pr√≥ximos Lembretes</h3>
                        <ul id="db-reminders" class="mt-2 space-y-2 text-slate-700 max-h-40 overflow-y-auto"></ul>
                    </div>
                </div>

                <div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-slate-700 mb-4">Progresso Geral das Metas</h3>
                    <div id="db-goals-progress" class="space-y-4"></div>
                </div>
            </section>
           
           <section id="day" class="page">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-slate-800">üìÖ Vis√£o do Dia</h2>
                    <button id="add-day-task-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Adicionar Tarefa</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-semibold text-slate-700 mb-4">Agenda Di√°ria</h3>
                        <ul id="day-tasks-list" class="space-y-3"></ul>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <div class="flex flex-col items-start gap-3 mb-3 sm:flex-row sm:items-center sm:justify-between">
                                <h3 class="text-xl font-semibold text-slate-700">Destaques do Dia</h3>
                                <button id="add-highlight-btn" class="bg-amber-500 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-amber-600 transition">Adicionar</button>
                            </div>
                            <ul id="highlights-list" class="space-y-2"></ul>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-xl font-semibold text-slate-700 mb-3">Bloco de Notas</h3>
                            <textarea id="notepad" class="w-full h-32 p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Anote suas ideias aqui..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-slate-700 mb-4">Hist√≥rico de Hoje</h3>
                    <ul id="day-tasks-history-list" class="space-y-3">
                        </ul>
                </div>
            </section>
           
          <section id="week" class="page">
            <h2 class="text-3xl font-bold text-slate-800 mb-6">üìÜ Vis√£o da Semana</h2>

            <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
                <div class="collapsible-header flex-col sm:flex-row items-start sm:items-center" data-collapsible-trigger>
                    <h3 class="text-xl font-semibold text-slate-700 mb-2 sm:mb-0">üß© Rotinas Fixas da Semana</h3>
                    <div class="flex items-center gap-2 w-full sm:w-auto justify-end">
                        <button id="add-weekly-habit-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-indigo-700 transition">Adicionar H√°bito</button>
                        <svg class="arrow w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
                <div id="weekly-habits-list" class="space-y-6" data-collapsible-content>
                    </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                        <h3 class="text-xl font-semibold text-slate-700">üéØ Objetivos da Semana</h3>
                        <button id="add-week-goal-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-indigo-700 transition">Adicionar</button>
                    </div>
                    <ul id="week-goals-list" class="space-y-2 list-disc list-inside text-slate-700"></ul>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div id="week-day-selector" class="flex justify-between border-b pb-4 mb-4"></div>
                    <div>
                        <ul id="weekly-tasks-list" class="space-y-3 mb-4"></ul>
                        <form id="add-weekly-task-form" class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="new-weekly-task-input" placeholder="Adicionar passo √† rotina..." class="flex-grow p-2 border rounded-md" required>
                            <button type="submit" class="w-full sm:w-auto bg-indigo-600 text-white px-4 rounded-md font-semibold hover:bg-indigo-700">Adicionar</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
                <div class="collapsible-header flex-col sm:flex-row items-start sm:items-center" data-collapsible-trigger>
                    <h3 class="text-xl font-semibold text-slate-700 mb-2 sm:mb-0">üß© Rotinas Fixas da Semana</h3>
                    <div class="flex items-center gap-2 w-full sm:w-auto justify-end">
                        <button id="add-weekly-habit-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-indigo-700 transition">Adicionar H√°bito</button>
                        <svg class="arrow w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
            </div>

        </section>

            <section id="month" class="page">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">üìÖ Vis√£o do M√™s</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="calendar-title" class="text-xl font-semibold text-slate-700 w-48 capitalize"></h3>
                            <div class="flex gap-2">
                                <button id="prev-month-btn" class="p-2 rounded-md hover:bg-slate-200 transition-colors" aria-label="M√™s anterior">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                                </button>
                                <button id="next-month-btn" class="p-2 rounded-md hover:bg-slate-200 transition-colors" aria-label="Pr√≥ximo m√™s">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center" id="calendar-grid">
                            </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-xl font-semibold text-slate-700">Resumo de Conquistas</h3>
                                <button id="add-achievement-btn" class="bg-indigo-600 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-indigo-700 transition">Adicionar</button>
                            </div>
                            <ul id="achievements-list" class="space-y-2 list-disc list-inside text-slate-600"></ul>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-xl font-semibold text-slate-700 mb-2">Produtividade</h3>
                            <p id="month-tasks-completed" class="text-4xl font-bold text-indigo-600">0</p>
                            <p class="text-slate-500">tarefas conclu√≠das este m√™s.</p>
                        </div>
                    </div>
                </div>
            </section>


            <section id="finance" class="page">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-slate-800">üí∞ Finan√ßas</h2>
                    <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                        <button id="add-expense-btn" class="flex-1 sm:w-auto bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition">Nova Despesa</button>
                        <button id="add-income-btn" class="flex-1 sm:w-auto bg-emerald-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-emerald-600 transition">Nova Receita</button>
                        <button id="add-recurring-btn" class="w-full sm:w-auto bg-sky-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-sky-600 transition">Nova Conta Recorrente</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <div class="collapsible-header" data-collapsible-trigger>
                                <h3 class="text-xl font-semibold text-slate-700">Contas Recorrentes</h3>
                                <svg class="arrow w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div id="recurring-transactions-list" class="space-y-4" data-collapsible-content>
                                </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-sm">
                             <div class="collapsible-header" data-collapsible-trigger>
                                <h3 class="text-xl font-semibold text-slate-700">√öltimas Transa√ß√µes (Hist√≥rico)</h3>
                                <svg class="arrow w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="overflow-x-auto" data-collapsible-content>
                                <table class="w-full text-left min-w-[500px]">
                                    <thead><tr class="border-b"><th class="py-2">Descri√ß√£o</th><th class="py-2">Categoria</th><th class="py-2 text-right">Valor</th><th class="py-2 text-center">A√ß√µes</th></tr></thead>
                                    <tbody id="transactions-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-xl font-semibold text-slate-700 mb-4">Gastos por Categoria</h3>
                            <canvas id="expensesChart"></canvas>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-slate-500 font-medium">Saldo Atual</h3>
                            <p id="finance-balance" class="text-4xl font-bold text-emerald-500 mt-2">R$ 0,00</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-slate-500 font-medium">Proje√ß√£o para o M√™s</h3>
                            <p class="text-3xl font-bold text-sky-500 mt-2">~ R$ 0,00</p>
                            <p class="text-slate-500 mt-1">saldo restante estimado</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="buy" class="page">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-slate-800">üõí Lista de Compras</h2>
                    <button id="add-shopping-category-btn" class="w-full sm:w-auto bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                        Nova Categoria +
                    </button>
                </div>
                <div id="shopping-categories-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </section>

            <section id="todo" class="page">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-slate-800">‚úÖ A Fazer</h2>
                    <button id="add-todo-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Adicionar Tarefa</button>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm overflow-x-auto">
                    <table class="w-full text-left min-w-[600px]">
                        <thead>
                            <tr class="border-b">
                                <th class="py-2 w-1/2">Tarefa</th>
                                <th class="py-2">Prioridade</th>
                                <th class="py-2">Status</th>
                                <th class="py-2 text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="todo-table-body"></tbody>
                    </table>
                </div>

                <div class="mt-12">
                    <h3 class="text-2xl font-bold text-slate-700 mb-6 border-t pt-8">üìã Hist√≥rico de Tarefas Conclu√≠das</h3>
                    <div id="todo-history-list" class="space-y-3">
                        </div>
                </div>
            </section>

            <section id="goals" class="page">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-slate-800">üéØ Metas</h2>
                    <button id="add-goal-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Adicionar Meta</button>
                </div>
                
                <div id="goals-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    </div>

                <div class="mt-12">
                    <h3 class="text-2xl font-bold text-slate-700 mb-6 border-t pt-8">üèÜ Hist√≥rico de Metas Conclu√≠das</h3>
                    <div id="goals-history-list" class="space-y-4">
                        </div>
                </div>
            </section>

            <section id="notes" class="page">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-slate-800">üìù Todas as Notas</h2>
                    <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                        <button id="add-note-group-btn" class="bg-sky-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-sky-700 transition">
                            Novo Grupo +
                        </button>
                        <button id="add-note-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">
                            Nova Nota +
                        </button>
                    </div>
                </div>
                <div id="notes-grid-container"></div>
            </section>
                        
            <section id="note-editor-page" class="page bg-white p-6 rounded-lg shadow-sm">
                
            </section>
        </main>
       
    </div>
            
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div id="modal-backdrop" class="fixed inset-0 modal-backdrop opacity-0" style="transition: opacity 0.3s ease;"></div>
        <div id="modal-content" class="relative bg-white rounded-lg shadow-xl w-full max-w-md m-4 p-6 modal-content opacity-0 scale-95" style="transition: all 0.3s ease;">
            <h3 id="modal-title" class="text-2xl font-bold text-slate-800 mb-4"></h3>
            <p id="modal-message" class="text-slate-600 my-4 hidden"></p>
            <div id="modal-form-content" class="space-y-4"></div>
            <div id="modal-buttons" class="mt-6 flex justify-end gap-3"></div>
            <button id="modal-close" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600" aria-label="Fechar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
    // ========================================================= ==========
    // 1. CONFIGURA√á√ÉO E UTILS
    // ===================================================================
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);
    const formatCurrency = (value) => (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    let deferredInstallPrompt = null;

    function checkLogin() {
        if (!currentProfileId) {
            showAlert("Fa√ßa login para usar esta funcionalidade.");
            return false;
        }
        return true;
    }

    const SUPABASE_URL = 'https://xbdvqegxtjyygibheikm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhiZHZxZWd4dGp5eWdpYmhlaWttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MDk4NzEsImV4cCI6MjA3NDM4NTg3MX0.GJrkOw6CyduBcNGXepqKN7ybauBKjv5PZ98s2L4zZ9I';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===================================================================
    // 2. L√ìGICA DO MENU RESPONSIVO
    // ===================================================================
    const menuContainer = $('#menu-container');
    const openMenuBtn = $('#open-menu-btn');
    const closeMenuBtn = $('#close-menu-btn');
    const menuOverlay = $('#menu-overlay');
    let displayedDate = new Date();
    function toggleMenu(show) {
        menuContainer.classList.toggle('menu-open', show);
        menuOverlay.classList.toggle('hidden', !show);
    }

    // ===================================================================
    // 3. ESTADO DA APLICA√á√ÉO E L√ìGICA DE AUTENTICA√á√ÉO
    // ===================================================================
    let state = {};
    let currentProfileId = null;

    async function refreshDataAndRender() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        const profileInfoDiv = $('#profile-info');
        const loginBtn = $('#auth-login-btn');
        const signupBtn = $('#auth-signup-btn');
        const logoutBtn = $('#auth-logout-btn');

        if (session?.user) {
            currentProfileId = session.user.id;
            if(profileInfoDiv) profileInfoDiv.textContent = `Logado como: ${session.user.email}`;
            loginBtn.classList.add('hidden');
            signupBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            await loadAllProfileData(currentProfileId);
        } else {
            currentProfileId = null;
            if(profileInfoDiv) profileInfoDiv.textContent = 'Nenhum usu√°rio logado.';
            loginBtn.classList.remove('hidden');
            signupBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            state = {
                dayTasks: [], dayHighlights: [], notepadContent: '', weekGoals: [],
                monthAchievements: [], transactions: [], shoppingList: [], todos: [], goals: [],
            };
        }
        renderAll();
    }
    
    async function loadAllProfileData(profileId) {
        const queries = [
            supabaseClient.from('day_tasks').select('*, day_subtasks(*)').eq('profile_id', profileId).order('created_at'),
            supabaseClient.from('day_highlights').select('*').eq('profile_id', profileId).order('created_at'),
            supabaseClient.from('notepad').select('content').eq('profile_id', profileId).maybeSingle(),
            supabaseClient.from('week_goals').select('*').eq('profile_id', profileId).order('created_at'),
            supabaseClient.from('month_achievements').select('*').eq('profile_id', profileId).order('created_at'),
            supabaseClient.from('transactions').select('*').eq('profile_id', profileId).order('created_at', { ascending: false }),
            supabaseClient.from('shopping_list').select('*').eq('profile_id', profileId).order('created_at'),
            supabaseClient.from('todos').select('*').eq('profile_id', profileId).order('created_at'),
            supabaseClient.from('goals').select('*').eq('profile_id', profileId).order('created_at'),
            supabaseClient.from('month_reminders').select('*').eq('profile_id', profileId),
            supabaseClient.from('shopping_categories').select('*').eq('profile_id', profileId).order('created_at'),
            supabaseClient.from('weekly_routine_tasks').select('*').eq('profile_id', profileId),
            supabaseClient.from('weekly_task_completions').select('*').eq('profile_id', profileId),
            supabaseClient.from('weekly_habits').select('*').eq('profile_id', profileId).order('created_at'),
            supabaseClient.from('habit_completions').select('*').eq('profile_id', profileId),
            supabaseClient.from('recurring_transactions').select('*').eq('profile_id', profileId).order('created_at'),
            supabaseClient.from('notes').select('*').eq('profile_id', profileId).order('updated_at', { ascending: false }),
            supabaseClient.from('note_groups').select('*').eq('profile_id', profileId).order('created_at'),
        ];
        try {
            const results = await Promise.all(queries);
            const [ dayTasks, dayHighlights, notepad, weekGoals, monthAchievements, transactions, shoppingList, todos, goals, monthReminders, shoppingCategories, weeklyRoutineTasks, weeklyTaskCompletions, weeklyHabits, habitCompletions, recurringTransactions, notes,noteGroups] = results.map(res => res.data);
            state = {
                dayTasks: dayTasks || [], 
                dayHighlights: dayHighlights || [], 
                notepadContent: notepad?.content || '',
                weekGoals: weekGoals || [], 
                monthAchievements: monthAchievements || [],
                transactions: transactions || [], 
                shoppingList: shoppingList || [], 
                todos: todos || [], 
                goals: goals || [],
                monthReminders: monthReminders || [],
                shoppingCategories: shoppingCategories || [],
                weeklyRoutineTasks: weeklyRoutineTasks || [], 
                weeklyTaskCompletions: weeklyTaskCompletions || [],
                weeklyHabits: weeklyHabits || [],
                habitCompletions: habitCompletions || [],
                recurringTransactions: recurringTransactions || [],
                notes: notes || [],
                noteGroups: noteGroups || [],
            };
        } catch (error) {
            console.error("Erro ao carregar dados:", error);
            showAlert(`Erro ao carregar dados: ${error.message}`);
        }
    }

    async function signUp(email, password) {
        const { error } = await supabaseClient.auth.signUp({ email, password });
        if (error) {
            showAlert(`Erro no cadastro: ${error.message}`);
        } else {
            showAlert('Cadastro realizado! Fa√ßa o login para continuar.');
            closeModal();
        }
    }

     async function signIn(email, password) {
        const errorMessageEl = $('#login-error-message');
        if (errorMessageEl) errorMessageEl.textContent = '';
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) {
            if (errorMessageEl) {
                errorMessageEl.textContent = 'E-mail ou senha inv√°lidos.';
            } else {
                openModal({
                    title: 'Erro no Login',
                    message: 'E-mail ou senha incorretos. Tente novamente.',
                    buttonsHtml: `<button id="modal-retry-login" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Tentar Novamente</button>`
                });
                $('#modal-retry-login').addEventListener('click', () => { history.back(); showAuthModal('login'); }, { once: true });
            }
        } else if (!errorMessageEl) {
            history.back(); 
        }
    }

    async function signOut() {
        const { error } = await supabaseClient.auth.signOut();
        if (error) showAlert(`Erro ao sair: ${error.message}`);
    }

    // ===================================================================
    // 4. L√ìGICA DO MODAL PERSONALIZADO
    // ===================================================================
    const modal = $('#modal'), modalBackdrop = $('#modal-backdrop'), modalContent = $('#modal-content'),
          modalTitle = $('#modal-title'), modalMessage = $('#modal-message'), modalFormContent = $('#modal-form-content'),
          modalButtons = $('#modal-buttons'), modalCloseBtn = $('#modal-close');

    function openModal({title, formHtml = '', message = '', buttonsHtml = ''}) {
        modalTitle.textContent = title;
        modalFormContent.innerHTML = formHtml;
        modalButtons.innerHTML = buttonsHtml;
        modalMessage.textContent = message;
        modalMessage.classList.toggle('hidden', !message);
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            modalBackdrop.classList.remove('opacity-0');
            modalContent.classList.remove('opacity-0', 'scale-95');
        }, 10);
        history.pushState({ modal: true }, null);
    }


    function closeModal() {
        modalBackdrop.classList.add('opacity-0');
        modalContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modalFormContent.innerHTML = '';
            modalButtons.innerHTML = '';
            modalMessage.innerHTML = '';
        }, 300);
    }
    function showAlert(message) {
        openModal({
            title: 'Aviso',
            message: message,
            buttonsHtml: `<button id="modal-ok" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">OK</button>`
        });
        $('#modal-ok').addEventListener('click', () => history.back(), { once: true });
    }

    function showAuthModal(type) {
        const isLogin = type === 'login';
        const forgotPasswordLink = isLogin
            ? `<div class="text-right mt-2"><a href="#" id="forgot-password-link" class="text-sm text-indigo-600 hover:underline">Esqueceu a senha?</a></div>`
            : '';
        openModal({
            title: isLogin ? 'Login' : 'Cadastro',
            formHtml: `<form id="auth-form">
                        <input type="email" id="auth-email" placeholder="Seu@email.com" class="w-full p-2 border rounded mb-4" autocomplete="email">
                        <input type="password" id="auth-password" placeholder="Sua senha" class="w-full p-2 border rounded" autocomplete="current-password">
                        ${forgotPasswordLink}
                    </form>`,
            buttonsHtml: `<button id="modal-cancel-auth" class="px-4 py-2 bg-slate-200 rounded-lg">Cancelar</button>
                        <button id="modal-confirm-auth" type="submit" form="auth-form" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">${isLogin ? 'Entrar' : 'Cadastrar'}</button>`
        });
        $('#modal-cancel-auth').addEventListener('click', () => history.back());
        $('#auth-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = $('#auth-email').value;
            const password = $('#auth-password').value;
            if (!email || !password) return showAlert("Por favor, preencha e-mail e senha.");
            if (isLogin) signIn(email, password);
            else signUp(email, password);
        });
    }


    function showForgotPasswordModal() {
        openModal({
            title: 'Recuperar Senha',
            formHtml: `
                <form id="forgot-password-form">
                    <p class="text-slate-600 mb-4 text-sm">Digite seu e-mail abaixo. Se ele estiver cadastrado, enviaremos um link para voc√™ criar uma nova senha.</p>
                    <input type="email" id="forgot-email" placeholder="Seu@email.com" class="w-full p-2 border rounded" required>
                </form>
            `,
            buttonsHtml: `
                <button id="modal-cancel-forgot" class="px-4 py-2 bg-slate-200 rounded-lg">Cancelar</button>
                <button id="modal-send-link" type="submit" form="forgot-password-form" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Enviar Link</button>
            `
        });

        $('#modal-cancel-forgot').addEventListener('click', () => history.back());

        $('#forgot-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = $('#forgot-email').value;
            const sendButton = $('#modal-send-link');
            sendButton.disabled = true;
            sendButton.textContent = 'Enviando...';

            const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.href.split('#')[0], // Envia para a p√°gina atual, sem o hash
            });

            if (error) {
                showAlert(`Erro: ${error.message}`);
            } else {
                closeModal();
                showAlert('Link de recupera√ß√£o enviado! Verifique sua caixa de entrada (e a pasta de spam).');
            }
            
            sendButton.disabled = false;
            sendButton.textContent = 'Enviar Link';
        });
    }

    function showUpdatePasswordModal() {
        openModal({
            title: 'Crie sua Nova Senha',
            formHtml: `
                <form id="update-password-form">
                    <input type="password" id="update-password" placeholder="Digite a nova senha" class="w-full p-2 border rounded mb-4" required>
                    <input type="password" id="update-password-confirm" placeholder="Confirme a nova senha" class="w-full p-2 border rounded" required>
                </form>
            `,
            buttonsHtml: `
                <button id="modal-confirm-update" type="submit" form="update-password-form" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Salvar Nova Senha</button>
            `
        });

        $('#update-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = $('#update-password').value;
            const passwordConfirm = $('#update-password-confirm').value;

            if (password !== passwordConfirm) {
                return showAlert('As senhas n√£o coincidem.');
            }
            if (password.length < 6) {
                return showAlert('A senha deve ter no m√≠nimo 6 caracteres.');
            }

            const { error } = await supabaseClient.auth.updateUser({ password: password });

            if (error) {
                showAlert(`Erro ao atualizar senha: ${error.message}`);
            } else {
                closeModal();
                showAlert('Senha alterada com sucesso! Voc√™ j√° pode fazer o login com a nova senha.');
            }
        });
    }





    function openCrudModal(options) {
        openModal({
            title: options.title,
            formHtml: `<form id="dynamic-crud-form" class="space-y-4">${options.formHtml}</form>`,
            buttonsHtml: `<button id="modal-cancel-form" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Cancelar</button><button id="modal-save-form" type="submit" form="dynamic-crud-form" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Salvar</button>`
        });
        $('#modal-cancel-form').addEventListener('click', () => history.back());
        $('#dynamic-crud-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formElement = e.target;
            const formData = new FormData(formElement);
            const data = {};
            for (const key of new Set(Array.from(formData.keys()))) {
                const allValues = formData.getAll(key);
                const input = formElement.querySelector(`[name="${key}"]`);
                if (!input) continue;

                if (input.type === 'checkbox' && allValues.length > 1) {
                    data[key] = allValues;
                } else if (input.type === 'checkbox') {
                    data[key] = input.checked;
                } else if (input.type === 'number') {
                    data[key] = parseFloat(String(allValues[0]).replace(',', '.')) || 0;
                } else {
                    data[key] = allValues[0];
                }
            }
            options.onSave(data);
        });

        if (options.item) {
            const formElement = $('#dynamic-crud-form');
            for (const key in options.item) {
                const inputs = formElement.querySelectorAll(`[name="${key}"]`);
                if (!inputs.length) continue;

                const firstInput = inputs[0];
                if (firstInput.type === 'radio') {
                    inputs.forEach(radio => {
                        if (radio.value === options.item[key]) {
                            radio.checked = true;
                        }
                    });
                } 
                else if (inputs.length > 1 && Array.isArray(options.item[key])) {
                    inputs.forEach(input => {
                        if(options.item[key].map(String).includes(input.value)) {
                            input.checked = true;
                        }
                    });
                } 
                else if (firstInput.type === 'checkbox') {
                    firstInput.checked = options.item[key];
                }
                else {
                    firstInput.value = options.item[key];
                }
            }
        }
    }
    

    function showNoteEditor(note = null) {
        const editorPage = $('#note-editor-page');
        const notesPage = $('#notes');
        const mainContent = $('main.flex-1');
        const isNewNote = note === null;
        
        notesPage.classList.remove('active');
        editorPage.classList.add('active');
        mainContent.style.paddingTop = '1rem';

        const groupsOptions = (state.noteGroups || []).map(g => 
            `<option value="${g.id}" ${note && note.group_id === g.id ? 'selected' : ''}>${g.name}</option>`
        ).join('');
        const deleteButtonHtml = isNewNote ? '' : `
            <button id="delete-note-btn" class="flex items-center gap-2 text-red-600 hover:text-red-800 font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                Excluir
            </button>
        `;

        editorPage.innerHTML = `
            <h2 class="text-2xl font-bold text-slate-800 mb-4">
                ${isNewNote ? 'Criar Nova Nota' : 'Editar Nota'}
            </h2>
            
            <div class="flex flex-col gap-4 md:flex-row md:justify-between md:items-center mb-4 border-b pb-4">
                <div class="flex items-center justify-between">
                    <button id="back-to-notes-btn" class="flex items-center gap-2 text-slate-600 hover:text-indigo-600 font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                        Voltar
                    </button>
                    ${deleteButtonHtml}
                </div>
                <div class="flex flex-col-reverse gap-3 sm:flex-row sm:items-center sm:gap-4">
                    <select id="note-group-selector" class="p-2 border rounded-md text-sm bg-white w-full sm:w-auto">
                        <option value="">Sem Grupo</option>
                        ${groupsOptions}
                    </select>
                    <button id="save-note-editor-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700 w-full sm:w-auto">Salvar</button>
                </div>
            </div>
            <div class="note-editor-content">
                <input id="note-editor-title" type="text" placeholder="T√≠tulo" class="w-full text-3xl font-bold p-2 focus:outline-none mb-4" value="${isNewNote ? '' : note.title || ''}">
                <textarea id="note-editor-content" placeholder="Comece a escrever..." class="w-full h-[calc(100vh-220px)] p-2 text-lg focus:outline-none resize-none">${isNewNote ? '' : note.content || ''}</textarea>
            </div>
        `;
        
        $('#back-to-notes-btn').addEventListener('click', () => hideNoteEditor());

        $('#save-note-editor-btn').addEventListener('click', async () => {
            const title = $('#note-editor-title').value.trim();
            const content = $('#note-editor-content').value.trim();
            const groupId = $('#note-group-selector').value || null;

            if (isNewNote) {
                await supabaseClient.from('notes').insert({ title, content, group_id: groupId, profile_id: currentProfileId });
            } else {
                await supabaseClient.from('notes').update({ title, content, group_id: groupId, updated_at: new Date().toISOString() }).eq('id', note.id);
            }
            
            hideNoteEditor();
            await refreshDataAndRender();
        });


        if (!isNewNote) {
            $('#delete-note-btn').addEventListener('click', async () => {
                if (confirm('Tem certeza que deseja excluir esta nota? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    await supabaseClient.from('notes').delete().eq('id', note.id);
                    hideNoteEditor();
                    await refreshDataAndRender();
                }
            });
        }
    }


    function hideNoteEditor() {
        const editorPage = $('#note-editor-page');
        const notesPage = $('#notes');
        const mainContent = $('main.flex-1');
        
        editorPage.classList.remove('active');
        editorPage.innerHTML = '';
        notesPage.classList.add('active');
        mainContent.style.paddingTop = ''; 
    }
        
    // ===================================================================
    // 5. NAVEGA√á√ÉO ENTRE P√ÅGINAS
    // ===================================================================
    const navLinks = $$('.nav-link'), pages = $$('.page'), navMenu = $('#nav-menu');
    let expensesChartInstance = null;

    function showPage(targetId, updateHistory = true) {
        navLinks.forEach(link => {
            link.classList.toggle('bg-indigo-600', link.getAttribute('href') === targetId);
            link.classList.toggle('text-white', link.getAttribute('href') === targetId);
            link.classList.toggle('text-slate-300', link.getAttribute('href') !== targetId);
        });
        pages.forEach(page => page.classList.toggle('active', `#${page.id}` === targetId));
        if (updateHistory) {
            window.history.pushState(null, '', targetId);
        }
        renderAll();
    }

    // ===================================================================
    // 6. FUN√á√ïES DE RENDERIZA√á√ÉO
    // ===================================================================
    function renderAll() {
        updateDashboard(); renderDayTasks(); renderDayHighlights(); renderNotepad(); 
        renderWeekGoals(); renderWeeklyRoutine(); renderMonthAchievements(); renderMonthAchievements(); renderTransactions();
        renderShoppingList(); renderTodos(); renderGoals(); renderCalendar();
        renderMonthProductivity();
        renderWeeklyHabits()
        renderMonthAchievements();
        renderRecurringTransactions();
        renderNotes();
    }
    
    function updateDashboard() {
        if(!state.dayTasks || !state.transactions || !state.goals || !state.shoppingList) return;
        
        const pendingTasks = state.dayTasks.filter(t => !t.completed).length;
        $('#db-tasks').innerHTML = `${pendingTasks} <span class="text-2xl text-slate-400 font-medium">/ ${state.dayTasks.length}</span>`;
        
        const balance = state.transactions.reduce((acc, t) => acc + (t.type === 'income' ? Number(t.amount) : -Number(t.amount)), 0);
        $('#db-balance').textContent = formatCurrency(balance);
        $('#finance-balance').textContent = formatCurrency(balance);
        
        $('#db-goals').textContent = state.goals.filter(g => g.current < g.target).length;
        
        $('#db-shopping').innerHTML = state.shoppingList.filter(i => !i.completed).slice(0, 3).map(i => `<li>- ${i.text}</li>`).join('') || '<li class="text-slate-400">Nenhum item.</li>';
        
        $('#db-goals-progress').innerHTML = state.goals.map(goal => {
            const percentage = goal.target > 0 ? Math.min(100, Math.round((goal.current / goal.target) * 100)) : 0;
            return `<div><div class="flex justify-between mb-1"><span class="text-slate-700 text-sm">${goal.text}</span><span class="text-slate-500 text-sm">${percentage}%</span></div><div class="w-full bg-slate-200 rounded-full h-2"><div class="bg-indigo-600 h-2 rounded-full" style="width: ${percentage}%"></div></div></div>`;
        }).join('');

        const remindersList = $('#db-reminders');
        if (remindersList) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const upcomingReminders = (state.monthReminders || [])
                .filter(r => new Date(r.reminder_date + 'T12:00:00') >= today)
                .sort((a, b) => new Date(a.reminder_date) - new Date(b.reminder_date))
                .slice(0, 4);

            if (upcomingReminders.length > 0) {
                remindersList.innerHTML = upcomingReminders.map(r => {
                    const date = new Date(r.reminder_date + 'T12:00:00');
                    const formattedDate = date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                    return `
                        <li>
                            <button class="goto-reminder-btn w-full text-left p-2 rounded-md hover:bg-slate-100 transition-colors" data-date="${r.reminder_date}">
                                <span class="font-bold text-indigo-600">${formattedDate}:</span>
                                <span class="ml-2">${r.text}</span>
                            </button>
                        </li>
                    `;
                }).join('');
            } else {
                remindersList.innerHTML = '<li class="text-slate-400">Nenhum lembrete futuro.</li>';
            }
        }
    }

   function renderRecurringTransactions() {
        const listEl = $('#recurring-transactions-list');
        if (!listEl) return;

        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();

        if (!state.recurringTransactions || state.recurringTransactions.length === 0) {
            listEl.innerHTML = '<p class="text-slate-400 text-sm">Nenhuma conta recorrente adicionada.</p>';
            return;
        }

        listEl.innerHTML = state.recurringTransactions.map(item => {
            const lastPaid = item.last_paid_date ? new Date(item.last_paid_date + 'T12:00:00') : null;
            let isPaidThisPeriod = false;
            if (item.interval === 'monthly' && lastPaid && lastPaid.getMonth() === currentMonth && lastPaid.getFullYear() === currentYear) {
                isPaidThisPeriod = true;
            }
            const isExpense = item.type === 'expense';
            const statusClass = isPaidThisPeriod ? 'bg-green-100 text-green-800' : 'bg-amber-100 text-amber-800';
            const statusText = isPaidThisPeriod ? 'Pago este m√™s' : 'Pendente';

            return `
                <div class="border-t pt-3">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold ${isExpense ? 'text-red-600' : 'text-emerald-600'}">${item.name}</p>
                            <p class="text-sm text-slate-500">${item.category || 'Sem categoria'} - Vence todo dia ${item.due_day}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg ${isExpense ? 'text-red-600' : 'text-emerald-600'}">${formatCurrency(item.amount)}</p>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 mt-2">
                        <button class="mark-as-paid-btn text-sm font-semibold ${isPaidThisPeriod ? 'text-gray-400 cursor-not-allowed' : 'text-green-600 hover:text-green-800'}" data-id="${item.id}" ${isPaidThisPeriod ? 'disabled' : ''}>
                            ‚úî ${isPaidThisPeriod ? 'Pago' : 'Confirmar Pagamento'}
                        </button>
                        <button class="edit-recurring-btn text-sm text-slate-500 hover:text-indigo-600" data-id="${item.id}">Editar</button>
                        <button class="delete-recurring-btn text-sm text-slate-500 hover:text-red-600" data-id="${item.id}">Excluir</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderNotes() {
    const gridContainer = $('#notes-grid-container');
    if (!gridContainer || !state.notes) return;

    const ungroupedNotes = state.notes.filter(n => !n.group_id);
    const noteGroups = state.noteGroups || [];

    let html = '<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full">';
    if (ungroupedNotes.length > 0) {
        html += ungroupedNotes.map(note => `
            <div data-note-id="${note.id}" class="note-card bg-white p-4 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow border">
                <h4 class="font-semibold text-slate-800 mb-2 truncate">${note.title || 'Nota sem t√≠tulo'}</h4>
                <p class="text-sm text-slate-600 overflow-hidden h-24">${(note.content || '').replace(/\n/g, '<br>')}</p>
                <p class="text-xs text-slate-400 mt-3 text-right">${new Date(note.updated_at).toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' })}</p>
            </div>
        `).join('');
    }
    html += '</div>';

    noteGroups.forEach(group => {
        const notesInGroup = state.notes.filter(n => n.group_id === group.id);
        html += `
            <div class="w-full mt-4">
                <div class="note-group-header collapsed" data-group-id="${group.id}">
                    <span class="color-dot" style="background-color: ${group.color || '#94a3b8'};"></span>
                    <span>${group.name}</span>
                    
                    <div class="ml-auto flex items-center gap-2 pr-2">
                        <button class="edit-group-btn p-1 rounded-full hover:bg-slate-300" data-group-id="${group.id}" title="Editar Grupo">
                           <svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg>
                        </button>
                        <button class="delete-group-btn p-1 rounded-full hover:bg-slate-300" data-group-id="${group.id}" title="Excluir Grupo">
                           <svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </div>

                    <svg class="arrow w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div class="note-group-content mt-2 collapsed" data-content-id="${group.id}">
                    ${notesInGroup.map(note => `
                        <div data-note-id="${note.id}" class="note-card bg-white p-4 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow border">
                            <h4 class="font-semibold text-slate-800 mb-2 truncate">${note.title || 'Nota sem t√≠tulo'}</h4>
                            <p class="text-sm text-slate-600 overflow-hidden h-24">${(note.content || '').replace(/\n/g, '<br>')}</p>
                            <p class="text-xs text-slate-400 mt-3 text-right">${new Date(note.updated_at).toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' })}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    if (ungroupedNotes.length === 0 && noteGroups.length === 0) {
         gridContainer.innerHTML = '<p class="text-slate-400 col-span-full">Nenhuma nota criada ainda. Clique em "Nova Nota" para come√ßar.</p>';
    } else {
         gridContainer.innerHTML = html;
    }
}

   function renderDayTasks() {
        const pendingList = $('#day-tasks-list');
        const historyList = $('#day-tasks-history-list');
        if (!pendingList || !historyList || !state.dayTasks) return;

        const pendingTasks = state.dayTasks.filter(task => !task.completed);
        const completedTasks = state.dayTasks.filter(task => task.completed);

        const today = new Date().toDateString();
        const completedToday = completedTasks
            .filter(task => task.completed_at && new Date(task.completed_at).toDateString() === today)
            .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));

        pendingList.innerHTML = pendingTasks.map(task => {
            const subtasksHtml = (task.day_subtasks || []).map(subtask => {
                return `<li class="flex items-center justify-between ml-8">
                    <div class="flex items-center flex-grow min-w-0"><input type="checkbox" data-id="${subtask.id}" class="h-4 w-4 rounded text-indigo-500 day-subtask-check" ${subtask.completed ? 'checked' : ''}><span class="ml-3 text-sm truncate ${subtask.completed ? 'text-slate-400 line-through' : 'text-slate-600'}">${subtask.text}</span></div>
                    <div class="flex gap-1 flex-shrink-0"><button data-id="${subtask.id}" data-task-id="${task.id}" class="edit-day-subtask-btn text-slate-400 hover:text-indigo-600 p-1" title="Editar"><svg class="pointer-events-none" width="14" height="14" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" fill="none" stroke="currentColor" stroke-width="2.5"></path></svg></button><button data-id="${subtask.id}" class="delete-day-subtask-btn text-slate-400 hover:text-red-600 p-1" title="Excluir"><svg class="pointer-events-none" width="14" height="14" viewBox="0 0 24 24"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="2.5"></path></svg></button></div>
                </li>`;
            }).join('');

            return `
            <li>
                <div class="flex items-center justify-between gap-4">
                    <div class="flex items-center flex-grow min-w-0">
                        <input type="checkbox" data-id="${task.id}" class="h-5 w-5 rounded text-indigo-600 day-task-check flex-shrink-0">
                        <span class="ml-3 truncate text-slate-800">${task.text}</span>
                    </div>
                    <div class="flex gap-2 flex-shrink-0">
                        <button data-id="${task.id}" class="add-day-subtask-btn text-slate-400 hover:text-green-600" title="Adicionar Subtarefa"><svg class="pointer-events-none" width="18" height="18" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19" fill="none" stroke="currentColor" stroke-width="2"></line><line x1="5" y1="12" x2="19" y2="12" fill="none" stroke="currentColor" stroke-width="2"></line></svg></button>
                        <button data-id="${task.id}" class="edit-day-task-btn text-slate-400 hover:text-indigo-600" title="Editar Tarefa"><svg class="pointer-events-none" width="18" height="18" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" fill="none" stroke="currentColor" stroke-width="2"></path></svg></button>
                        <button data-id="${task.id}" class="delete-day-task-btn text-slate-400 hover:text-red-600" title="Excluir Tarefa"><svg class="pointer-events-none" width="18" height="18" viewBox="0 0 24 24"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="2"></path></svg></button>
                    </div>
                </div>
                <ul class="space-y-2 mt-2">${subtasksHtml}</ul>
            </li>`;
        }).join('') || '<p class="text-slate-400 text-sm">Nenhuma tarefa pendente. Bom trabalho!</p>';
        
        historyList.innerHTML = completedToday.map(task => {
            const completionDate = new Date(task.completed_at);
            const formattedCompletion = completionDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }) + ' ' + completionDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            return `
            <li>
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input type="checkbox" data-id="${task.id}" class="h-5 w-5 rounded text-indigo-600 day-task-check" checked> 
                        <span class="ml-3 text-slate-500 line-through">${task.text}</span>
                    </div>
                    <span class="text-sm text-slate-400">${formattedCompletion}</span>
                </div>
            </li>`;
        }).join('') || '<p class="text-slate-400 text-sm">Nenhuma tarefa conclu√≠da hoje ainda.</p>';
    }
    
    function renderDayHighlights() {
        const list = $('#highlights-list');
        if (!state.dayHighlights) { list.innerHTML = ''; return; }
        list.innerHTML = state.dayHighlights.map(highlight => `<li class="group flex justify-between items-center bg-amber-100 text-amber-800 p-3 rounded-md"><span class="break-all">${highlight.text}</span><div class="hidden group-hover:flex gap-2 flex-shrink-0 ml-2"><button data-id="${highlight.id}" class="edit-highlight-btn text-amber-700 hover:text-amber-900"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg></button><button data-id="${highlight.id}" class="delete-highlight-btn text-amber-700 hover:text-red-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></li>`).join('');
    }
    
    function renderNotepad() { $('#notepad').value = state.notepadContent || ''; }
    
    function renderWeekGoals() {
        const list = $('#week-goals-list');
        if (!state.weekGoals) { list.innerHTML = ''; return; }
        list.innerHTML = state.weekGoals.map(goal => `<li class="flex justify-between items-center group"><span>${goal.text}</span><div class="hidden group-hover:flex gap-2"><button data-id="${goal.id}" class="edit-week-goal-btn text-slate-400 hover:text-indigo-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg></button><button data-id="${goal.id}" class="delete-week-goal-btn text-slate-400 hover:text-red-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></li>`).join('');
    }
    

    function renderMonthAchievements() {
        const list = $('#achievements-list');
        if (!state.monthAchievements) { list.innerHTML = ''; return; }
        list.innerHTML = state.monthAchievements.map(achievement => `<li class="group flex justify-between items-center"><span>${achievement.text}</span><div class="hidden group-hover:flex gap-2"><button data-id="${achievement.id}" class="edit-achievement-btn text-slate-400 hover:text-indigo-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg></button><button data-id="${achievement.id}" class="delete-achievement-btn text-slate-400 hover:text-red-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></li>`).join('');
    }

    function renderCalendar() {
        const grid = $('#calendar-grid');
        const title = $('#calendar-title');
        if (!grid || !title) return; 

        grid.innerHTML = '';
        
        const year = displayedDate.getFullYear();
        const month = displayedDate.getMonth();

        title.textContent = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' }).format(displayedDate);

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const todayRef = new Date();
        const todayString = `${todayRef.getFullYear()}-${String(todayRef.getMonth() + 1).padStart(2, '0')}-${String(todayRef.getDate()).padStart(2, '0')}`;

        const daysOfWeek = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SAB'];
        grid.innerHTML = daysOfWeek.map(d => `<div class="font-semibold text-slate-500 text-sm p-2">${d}</div>`).join('');
        
        for (let i = 0; i < firstDayOfMonth; i++) {
            grid.insertAdjacentHTML('beforeend', '<div></div>');
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div');
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            dayEl.className = 'day-cell p-2 flex items-center justify-center';
            dayEl.textContent = day;
            dayEl.dataset.date = dateString;

            if (state.monthReminders?.some(r => r.reminder_date === dateString)) {
                dayEl.classList.add('has-reminder');
            }
            if (dateString === todayString) {
                dayEl.classList.add('is-today');
            }
            grid.appendChild(dayEl);
        }
    }

    function renderMonthProductivity() {
        const productivityEl = $('#month-tasks-completed');
        if (!productivityEl || !state.dayTasks) {
            if (productivityEl) productivityEl.textContent = '0';
            return;
        }
        const currentYear = displayedDate.getFullYear();
        const currentMonth = displayedDate.getMonth();
        const completedThisMonth = state.dayTasks.filter(task => {
            if (!task.completed || !task.updated_at) {
                return false;
            }
            const taskUpdateDate = new Date(task.updated_at);
            return taskUpdateDate.getFullYear() === currentYear &&
                   taskUpdateDate.getMonth() === currentMonth;
        });
        productivityEl.textContent = completedThisMonth.length;
    }

    async function showRemindersForDate(dateString) {
        if (!checkLogin()) return;
        const date = new Date(dateString + 'T12:00:00');
        const formattedDate = new Intl.DateTimeFormat('pt-BR', {dateStyle: 'long'}).format(date);
        modalFormContent.dataset.currentDate = dateString;
        const renderContent = () => {
            const remindersForDay = state.monthReminders.filter(r => r.reminder_date === dateString);
            
            const remindersHtml = remindersForDay.length > 0
                ? `<ul class="space-y-2 mb-4 max-h-40 overflow-y-auto">${remindersForDay.map(r => `
                    <li class="flex justify-between items-center bg-slate-100 p-2 rounded-md text-sm group">
                        <span>${r.text}</span>
                        <div class="hidden group-hover:flex items-center">
                            <button data-id="${r.id}" class="edit-reminder-btn text-blue-500 hover:text-blue-700 p-1" title="Editar Lembrete">
                                <svg class="pointer-events-none" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg>
                            </button>
                            <button data-id="${r.id}" class="delete-reminder-btn text-red-500 hover:text-red-700 p-1 font-bold text-lg" title="Excluir Lembrete">&times;</button>
                        </div>
                    </li>`).join('')}</ul>`
                : '<p class="text-slate-500 mb-4">Nenhum lembrete para este dia.</p>';
            const formHtml = `<form id="add-reminder-form" class="flex gap-2"><input id="new-reminder-text" type="text" placeholder="Novo lembrete..." class="flex-grow p-2 border rounded-md"><button type="submit" class="bg-indigo-600 text-white px-4 rounded-md hover:bg-indigo-700">Adicionar</button></form>`;
            modalFormContent.innerHTML = remindersHtml + formHtml;
        };

        openModal({
            title: `Lembretes para ${formattedDate}`,
            buttonsHtml: `<button id="modal-close-reminders" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Fechar</button>`
        });

        renderContent();
        $('#modal-close-reminders').addEventListener('click', () => history.back(), { once: true });
    }

    function renderTransactions() {
        const body = $('#transactions-table-body');
        if (!state.transactions) { body.innerHTML = ''; return; }
        body.innerHTML = state.transactions.map(t => `<tr class="border-b"><td class="py-3 px-1">${t.description}</td><td class="px-1">${t.category}</td><td class="text-right px-1 ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}">${t.type === 'income' ? '+' : '-'} ${formatCurrency(t.amount)}</td><td class="text-center px-1"><button data-id="${t.id}" class="edit-transaction-btn text-slate-400 hover:text-indigo-600 p-1"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg></button><button data-id="${t.id}" class="delete-transaction-btn text-slate-400 hover:text-red-600 p-1"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></td></tr>`).join('');
        renderExpensesChart();
    }

    function renderExpensesChart() {
        const ctx = document.getElementById('expensesChart');
        if (!ctx) return;
        if (expensesChartInstance) expensesChartInstance.destroy();
        if(!state.transactions || state.transactions.length === 0) return;
        const expenseData = state.transactions.filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + Number(t.amount); return acc; }, {});
        expensesChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(expenseData), datasets: [{ data: Object.values(expenseData), backgroundColor: ['rgba(79, 70, 229, 0.8)','rgba(245, 158, 11, 0.8)','rgba(14, 165, 233, 0.8)','rgba(239, 68, 68, 0.8)'], borderColor: '#fff' }] }, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
    }

    function renderShoppingList() {
        const container = $('#shopping-categories-container');
        if (!container) return;

        const defaultCategories = [
            { name: 'Mercado' },{ name: 'Tecnologia' }, { name: 'Lazer' }
        ];

        const allCategories = [...defaultCategories, ...(state.shoppingCategories || [])];
        
        container.innerHTML = allCategories.map(category => {
            const categoryName = category.name;
            const items = (state.shoppingList || []).filter(item => item.category === categoryName);
            const itemsHtml = items.map(item => `
                <li class="flex items-center justify-between group">
                    <div class="flex items-center">
                        <input type="checkbox" data-id="${item.id}" class="h-5 w-5 rounded text-indigo-600 shopping-item-check" ${item.completed ? 'checked' : ''}>
                        <span class="ml-3 ${item.completed ? 'text-slate-500 line-through' : 'text-slate-800'}">${item.text}</span>
                    </div>
                    <div class="hidden group-hover:flex gap-2">
                        <button data-id="${item.id}" class="edit-shopping-item-btn text-slate-400 hover:text-indigo-600"><svg class="pointer-events-none" width="16" height="16" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" fill="none" stroke="currentColor" stroke-width="2"></path></svg></button>
                        <button data-id="${item.id}" class="delete-shopping-item-btn text-slate-400 hover:text-red-600"><svg class="pointer-events-none" width="16" height="16" viewBox="0 0 24 24"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="2"></path></svg></button>
                    </div>
                </li>
            `).join('');

            const deleteCategoryBtn = category.id 
                ? `<button data-id="${category.id}" class="delete-shopping-category-btn text-slate-400 hover:text-red-500" title="Excluir categoria">&times;</button>`
                : '';

            return `
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-slate-700">${categoryName}</h3>
                        <div class="flex items-center gap-2">
                            ${deleteCategoryBtn}
                            <button data-category="${categoryName}" class="add-shopping-item-btn bg-indigo-600 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-indigo-700 transition">Adicionar</button>
                        </div>
                    </div>
                    <ul class="space-y-3">${itemsHtml}</ul>
                </div>
            `;
        }).join('');
    }
    function renderTodos() {
        const activeBody = $('#todo-table-body');
        const historyList = $('#todo-history-list');
        if (!activeBody || !historyList || !state.todos) return;

        const activeTodos = state.todos.filter(todo => todo.status !== 'concluido');
        const completedTodos = state.todos.filter(todo => todo.status === 'concluido')
            .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));

        const priorityMap = { baixa: 'bg-green-100 text-green-800', media: 'bg-amber-100 text-amber-800', alta: 'bg-red-100 text-red-800' };
        const statusMap = { pendente: 'bg-slate-100 text-slate-800', andamento: 'bg-sky-100 text-sky-800' };


        activeBody.innerHTML = activeTodos.map(todo => `
            <tr class="border-b">
                <td class="py-4 px-1">${todo.text}</td>
                <td class="px-1"><span class="px-2 py-1 text-xs font-semibold rounded-full ${priorityMap[todo.priority]}">${todo.priority}</span></td>
                <td class="px-1"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusMap[todo.status]}">${todo.status}</span></td>
                <td class="text-center px-1">
                    <button data-id="${todo.id}" class="edit-todo-btn text-slate-400 hover:text-indigo-600 p-1"><svg class="pointer-events-none" width="16" height="16" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" fill="none" stroke="currentColor" stroke-width="2"></path></svg></button>
                    <button data-id="${todo.id}" class="delete-todo-btn text-slate-400 hover:text-red-600 p-1"><svg class="pointer-events-none" width="16" height="16" viewBox="0 0 24 24"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="2"></path></svg></button>
                </td>
            </tr>
        `).join('');
        if(activeBody.innerHTML === '') activeBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-slate-400">Nenhuma tarefa ativa.</td></tr>';


        historyList.innerHTML = completedTodos.map(todo => {
            const completionDate = todo.completed_at ? new Date(todo.completed_at).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' }) : '';
            return `
                <div class="bg-slate-50 p-3 rounded-lg border flex justify-between items-center">
                    <div>
                        <p class="font-medium text-slate-500 line-through">${todo.text}</p>
                        <p class="text-sm text-slate-400">Conclu√≠da em: ${completionDate}</p>
                    </div>
                    <button data-id="${todo.id}" class="edit-todo-btn text-sm font-semibold text-blue-600 hover:text-blue-800" title="Reabrir tarefa">Reabrir</button>
                </div>
            `;
        }).join('');
        if(historyList.innerHTML === '') historyList.innerHTML = '<p class="text-slate-400 text-sm">Nenhuma tarefa conclu√≠da.</p>';
    }
    function renderGoals() {
        const activeList = $('#goals-list');
        const historyList = $('#goals-history-list');
        if (!activeList || !historyList || !state.goals) return;
        const activeGoals = state.goals.filter(g => g.completed_at === null);
        const completedGoals = state.goals.filter(g => g.completed_at !== null)
            .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));

        const categoryColors = { Financeira: 'bg-indigo-600', Sa√∫de: 'bg-emerald-500', Estudos: 'bg-amber-500', Pessoal: 'bg-sky-500' };
        

        activeList.innerHTML = activeGoals.map(goal => {
            const percentage = goal.target > 0 ? Math.min(100, Math.round((goal.current / goal.target) * 100)) : 0;
            const isReadyToComplete = percentage >= 100;

            
            const completeButtonHtml = isReadyToComplete 
                ? `<button data-id="${goal.id}" class="complete-goal-btn mt-3 w-full text-center bg-green-500 text-white text-sm py-2 rounded-lg hover:bg-green-600 transition font-semibold">üèÜ Concluir e Arquivar</button>` 
                : '';

            return `
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-xl font-semibold text-slate-700">${goal.category}</h3>
                        <p class="text-slate-600 mt-1">${goal.text}</p>
                    </div>
                    <div class="flex gap-2">
                        <button data-id="${goal.id}" class="edit-goal-btn text-slate-400 hover:text-indigo-600"><svg class="pointer-events-none" width="18" height="18" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" fill="none" stroke="currentColor" stroke-width="2"></path></svg></button>
                        <button data-id="${goal.id}" class="delete-goal-btn text-slate-400 hover:text-red-600"><svg class="pointer-events-none" width="18" height="18" viewBox="0 0 24 24"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="2"></path></svg></button>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between mb-1 items-center">
                        <div class="flex items-center gap-3">
                            <button data-id="${goal.id}" data-action="decrement" class="goal-adjust-btn bg-slate-200 text-slate-600 rounded-full w-7 h-7 flex items-center justify-center font-bold text-lg hover:bg-slate-300 transition">-</button>
                            <span class="text-slate-700 text-sm">${goal.unit === 'R$' ? formatCurrency(goal.current) : goal.current} / ${goal.unit === 'R$' ? formatCurrency(goal.target) : goal.target} ${goal.unit !== '%' && goal.unit !== 'R$' ? goal.unit : ''}</span>
                            <button data-id="${goal.id}" data-action="increment" class="goal-adjust-btn bg-slate-200 text-slate-600 rounded-full w-7 h-7 flex items-center justify-center font-bold text-lg hover:bg-slate-300 transition">+</button>
                        </div>
                        <span class="text-slate-500 font-semibold">${percentage}%</span>
                    </div>
                    
                    
                    <div class="progress-bar-container" data-id="${goal.id}">
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div class="${categoryColors[goal.category] || 'bg-slate-500'} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <div class="progress-handle" style="left: ${percentage}%"></div>
                    </div>


                    ${completeButtonHtml}
                </div>
            </div>`;
        }).join('');
        if(activeList.innerHTML === '') activeList.innerHTML = '<p class="text-slate-500 col-span-1 md:col-span-2">Nenhuma meta ativa no momento.</p>';


        historyList.innerHTML = completedGoals.map(goal => {
            const completionDate = new Date(goal.completed_at).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
            return `
            <div class="bg-slate-50 p-4 rounded-lg border flex justify-between items-center">
                <div>
                    <p class="font-semibold text-slate-700">${goal.text}</p>
                    <p class="text-sm text-slate-500">Conclu√≠da em: ${completionDate}</p>
                </div>
                <button data-id="${goal.id}" class="uncomplete-goal-btn text-sm font-semibold text-blue-600 hover:text-blue-800" title="Reativar meta">Reativar</button>
            </div>
            `;
        }).join('');
        if(historyList.innerHTML === '') historyList.innerHTML = '<p class="text-slate-400 text-sm">Nenhuma meta conclu√≠da ainda.</p>';
    }

    function renderWeeklyRoutine() { 
        if (state.selectedDayOfWeek === undefined) {
            state.selectedDayOfWeek = new Date().getDay();
        }

        const daySelector = $('#week-day-selector');
        const tasksList = $('#weekly-tasks-list');
        const container = tasksList?.parentElement;
        if (!daySelector || !tasksList || !container) return;

        const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        const today = new Date().getDay();
        const todayStr = new Date().toISOString().split('T')[0];
        daySelector.innerHTML = weekDays.map((day, index) => {
            const isSelected = index === state.selectedDayOfWeek;
            const isToday = index === today;
            let buttonClasses = 'p-2 rounded-full w-10 h-10 font-bold flex items-center justify-center transition-colors ';
            if (isSelected) {
                buttonClasses += 'bg-indigo-600 text-white shadow-md';
            } else if (isToday) {
                buttonClasses += 'bg-indigo-100 text-indigo-800';
            } else {
                buttonClasses += 'hover:bg-slate-100 text-slate-600';
            }
            return `<button data-day="${index}" class="${buttonClasses}">${day}</button>`;
        }).join('');
        const tasksForSelectedDay = (state.weeklyRoutineTasks || []).filter(task => task.day_of_week === state.selectedDayOfWeek);
        let progressHeaderHtml = `<h4 class="text-lg font-semibold text-slate-600 mb-4">Passos para ${weekDays[state.selectedDayOfWeek]}</h4>`;
        
        if (state.selectedDayOfWeek === today) {
            const totalTasks = tasksForSelectedDay.length;
            const completedTasks = tasksForSelectedDay.filter(task => 
                (state.weeklyTaskCompletions || []).some(c => c.task_id === task.id && c.completion_date === todayStr)
            ).length;
            const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;

            progressHeaderHtml = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-semibold text-slate-800">Passos de Hoje</h4>
                        <span class="text-sm font-bold text-slate-500">${completedTasks} / ${totalTasks}</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;
        }
        tasksList.innerHTML = tasksForSelectedDay.map(task => {
            const isCompleted = (state.weeklyTaskCompletions || []).some(c => c.task_id === task.id && c.completion_date === todayStr);
            const isDisabled = state.selectedDayOfWeek !== today;

            return `
                <li class="flex items-center justify-between group">
                    <div class="flex items-center">
                        <input type="checkbox" id="wtask_${task.id}" data-task-id="${task.id}" class="h-5 w-5 rounded text-indigo-600 weekly-task-check" ${isCompleted ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                        <label for="wtask_${task.id}" class="ml-3 ${isCompleted ? 'text-slate-400 line-through' : 'text-slate-800'}">${task.description}</label>
                    </div>
                    <button data-task-id="${task.id}" class="delete-weekly-task-btn text-slate-400 hover:text-red-600 p-1 hidden group-hover:block" title="Excluir passo">&times;</button>
                </li>
            `;
        }).join('') || '<li class="text-slate-400 text-sm">Nenhum passo definido para este dia.</li>';
        const existingHeader = container.querySelector('.progress-header');
        if (existingHeader) {
            existingHeader.remove();
        }
        tasksList.insertAdjacentHTML('beforebegin', `<div class="progress-header">${progressHeaderHtml}</div>`);
    }

   function renderWeeklyHabits() {
        const listEl = $('#weekly-habits-list');
        if (!listEl) return;

        const weekDaysMap = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        
        const getStartOfWeek = (date) => {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        };
        const startOfWeek = getStartOfWeek(new Date());

        if (!state.weeklyHabits || state.weeklyHabits.length === 0) {
            listEl.innerHTML = '<p class="text-slate-400 text-sm">Nenhum h√°bito fixo adicionado. Crie um para monitorar sua const√¢ncia!</p>';
            return;
        }

        listEl.innerHTML = state.weeklyHabits.map(habit => {
            const formattedDays = habit.days_of_week.sort((a, b) => a - b).map(d => weekDaysMap[d]).join(', ');
            let timeString = '';
            if (habit.time) {
                const startTime = habit.time.substring(0, 5);
                if (habit.time_end) {
                    const endTime = habit.time_end.substring(0, 5);
                    timeString = `‚Äî ${startTime} ~ ${endTime}`;
                } else {
                    timeString = `‚Äî ${startTime}`; 
                }
            }

            const checkboxesHtml = weekDaysMap.map((day, index) => {
                const currentDate = new Date(startOfWeek);
                currentDate.setDate(startOfWeek.getDate() + index);
                const dateString = currentDate.toISOString().split('T')[0];
                const isEnabled = habit.days_of_week.includes(index);
                const isChecked = (state.habitCompletions || []).some(c => c.habit_id === habit.id && c.completion_date === dateString);
                return `<label class="flex flex-col items-center gap-1 ${isEnabled ? 'cursor-pointer' : 'opacity-20'}">
                    <span class="text-xs">${day}</span>
                    <input type="checkbox" data-habit-id="${habit.id}" data-date="${dateString}" class="h-5 w-5 rounded text-green-500 weekly-habit-check" ${isChecked ? 'checked' : ''} ${!isEnabled ? 'disabled' : ''}>
                </label>`;
            }).join('');

            return `
                <div class="border-t pt-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-slate-800">${habit.name}</h4>
                            <p class="text-sm text-slate-500">${formattedDays} ${timeString}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-weekly-habit-btn p-1 text-slate-400 hover:text-indigo-600" data-id="${habit.id}"><svg class="pointer-events-none" width="16" height="16" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" fill="none" stroke="currentColor" stroke-width="2"></path></svg></button>
                            <button class="delete-weekly-habit-btn p-1 text-slate-400 hover:text-red-600" data-id="${habit.id}">&times;</button>
                        </div>
                    </div>
                    <div class="flex justify-around mt-3">${checkboxesHtml}</div>
                </div>
            `;
        }).join('');
    }



    // ===================================================================
    // 7. SETUP DE EVENTOS
    // ===================================================================
    
    function setupEventListeners() {
        openMenuBtn.addEventListener('click', () => toggleMenu(true));
        closeMenuBtn.addEventListener('click', () => toggleMenu(false));
        menuOverlay.addEventListener('click', () => toggleMenu(false));
        const swipeHandle = $('#swipe-handle');
        if (swipeHandle) {
            swipeHandle.addEventListener('click', () => toggleMenu(true));
        }
        const installPwaBtn = $('#install-pwa-btn');
        if (installPwaBtn) {
            installPwaBtn.addEventListener('click', async () => {
                if (deferredInstallPrompt) {
                    deferredInstallPrompt.prompt();
                    const { outcome } = await deferredInstallPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    deferredInstallPrompt = null;
                    installPwaBtn.classList.add('hidden');
                }
            });
        }



        let touchStartX = 0;
        let touchEndX = 0;
        const swipeThreshold = 50;



        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipeGesture();
        });

       document.body.addEventListener('click', (e) => {
            if (e.target.id === 'forgot-password-link') {
                e.preventDefault();
                closeModal();
                setTimeout(() => {
                    showForgotPasswordModal();
                }, 300);
            }
        });




        function handleSwipeGesture() {
            const swipeDistance = touchEndX - touchStartX;
    
            if (swipeDistance > swipeThreshold && touchStartX < 50) { 
                if (!menuContainer.classList.contains('menu-open')) {
                    toggleMenu(true);
                }
            }
            if (swipeDistance < -swipeThreshold) {
                if (menuContainer.classList.contains('menu-open')) {
                    toggleMenu(false);
                }
            }
        }

        $('#auth-login-btn').addEventListener('click', () => showAuthModal('login'));
        $('#auth-signup-btn').addEventListener('click', () => showAuthModal('signup'));
        $('#auth-logout-btn').addEventListener('click', signOut);
        
        navMenu.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link) {
                e.preventDefault();
                showPage(link.getAttribute('href'));
                if (window.innerWidth <= 768) toggleMenu(false);
            }
        });

        window.addEventListener('popstate', (e) => {
            if (!modal.classList.contains('hidden')) {
                closeModal();
            } else {
                const hash = window.location.hash || '#dashboard';
                showPage(hash, false); 
            }
        });

        modalCloseBtn.addEventListener('click', () => history.back());
        
       modalFormContent.addEventListener('click', async (e) => {
            const target = e.target;
            const dateString = modalFormContent.dataset.currentDate;

            if (target.matches('button[type="submit"]') && target.closest('form')?.id === 'add-reminder-form') {
                e.preventDefault(); 
                const form = target.closest('form');
                const textInput = form.querySelector('#new-reminder-text');
                if (textInput && textInput.value.trim() && dateString) {
                    target.disabled = true;
                    target.textContent = 'Salvando...';
                    await supabaseClient.from('month_reminders').insert({
                        profile_id: currentProfileId,
                        reminder_date: dateString,
                        text: textInput.value.trim()
                    });
                    await refreshDataAndRender();
                    showRemindersForDate(dateString);
                }
            }
            const deleteButton = target.closest('.delete-reminder-btn');
            if (deleteButton) {
                const id = deleteButton.dataset.id;
                if (id && dateString) {
                    await supabaseClient.from('month_reminders').delete().eq('id', id);
                    await refreshDataAndRender();
                    showRemindersForDate(dateString);
                }
            }
            const editButton = target.closest('.edit-reminder-btn');
            if (editButton) {
                const reminderId = editButton.dataset.id;
                const reminderToEdit = state.monthReminders.find(r => r.id === reminderId);
                
                if (reminderToEdit) {
                    openCrudModal({
                        title: 'Editar Lembrete',
                        item: reminderToEdit,
                        formHtml: `<input name="text" class="w-full p-2 border rounded" value="${reminderToEdit.text}">`,
                        onSave: async (data) => {
                            if (!data.text) return;
                            await supabaseClient.from('month_reminders').update({ text: data.text }).eq('id', reminderId);
                            history.back();
                            
                            await refreshDataAndRender();
                            showRemindersForDate(dateString); 
                        }
                    });
                }
            }
        });


        $('main').addEventListener('click', (e) => {
            const trigger = e.target.closest('[data-collapsible-trigger]');
            if (!trigger) return;

            const content = trigger.nextElementSibling;
            if (content && content.matches('[data-collapsible-content]')) {
                trigger.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
            }
        });




        $('#day').addEventListener('input', async (e) => {
            if (e.target.id === 'notepad') {
                if (!currentProfileId) return;
                state.notepadContent = e.target.value;
                await supabaseClient.from('notepad').upsert({ profile_id: currentProfileId, content: e.target.value });
            }
        });
        $('#notes').addEventListener('click', async  (e) => {
            const target = e.target;
            const noteCard = target.closest('.note-card');
            if (noteCard) {
                const noteId = noteCard.dataset.noteId;
                const noteToEdit = state.notes.find(n => n.id === noteId);
                if (noteToEdit) {
                    showNoteEditor(noteToEdit);
                }
                return;
            }

            if (target.id === 'add-note-btn') {
                showNoteEditor(null);
                return;
            }

            if (target.id === 'add-note-group-btn') {
                if (!checkLogin()) return;
                const groupColors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899', '#64748b'];
                let colorsHtml = groupColors.map((color, index) => `
                    <div class="color-circle-wrapper">
                        <input type="radio" id="color-${index}" name="color" value="${color}" class="hidden" ${index === 0 ? 'checked' : ''}>
                        <label for="color-${index}" class="color-circle" style="background-color: ${color};" title="${color}"></label>
                    </div>
                `).join('');
                openCrudModal({
                    title: 'Criar Novo Grupo',
                    formHtml: `
                        <input name="name" placeholder="Nome do grupo" class="w-full p-2 border rounded">
                        <label class="block mt-4 mb-2">Cor do grupo:</label>
                        <div class="flex gap-2 flex-wrap">${colorsHtml}</div>
                    `,
                    onSave: async (data) => {
                        if (!data.name || !data.color) return;
                        await supabaseClient.from('note_groups').insert({ name: data.name, color: data.color, profile_id: currentProfileId });
                        history.back();
                        await refreshDataAndRender();
                    }
                });
                return;
            }
            

            const editGroupBtn = target.closest('.edit-group-btn');
            if (editGroupBtn) {
                e.stopPropagation(); 
                const groupId = editGroupBtn.dataset.groupId;
                const groupToEdit = state.noteGroups.find(g => g.id === groupId);
                if (!groupToEdit) return;

                const groupColors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899', '#64748b'];
                let colorsHtml = groupColors.map((color, index) => `
                    <div class="color-circle-wrapper">
                        <input type="radio" id="color-${index}" name="color" value="${color}" class="hidden" ${groupToEdit.color === color ? 'checked' : ''}>
                        <label for="color-${index}" class="color-circle" style="background-color: ${color};" title="${color}"></label>
                    </div>
                `).join('');

                openCrudModal({
                    title: 'Editar Grupo',
                    item: groupToEdit,
                    formHtml: `
                        <input name="name" placeholder="Nome do grupo" class="w-full p-2 border rounded" value="${groupToEdit.name}">
                        <label class="block mt-4 mb-2">Cor do grupo:</label>
                        <div class="flex gap-2 flex-wrap">${colorsHtml}</div>
                    `,
                    onSave: async (data) => {
                        if (!data.name || !data.color) return;
                        await supabaseClient.from('note_groups').update({ name: data.name, color: data.color }).eq('id', groupId);
                        history.back();
                        await refreshDataAndRender();
                    }
                });
                return;
            }

            const deleteGroupBtn = target.closest('.delete-group-btn');
            if(deleteGroupBtn) {
                e.stopPropagation();
                const groupId = deleteGroupBtn.dataset.groupId;
                if (confirm('Tem certeza que deseja excluir este grupo? As notas dentro dele N√ÉO ser√£o apagadas, ficar√£o apenas sem grupo.')) {
                    await supabaseClient.from('note_groups').delete().eq('id', groupId);
                    await refreshDataAndRender();
                }
                return;
            }

            const groupHeader = target.closest('.note-group-header');
            if(groupHeader) {
                const groupId = groupHeader.dataset.groupId;
                const content = $(`[data-content-id="${groupId}"]`);
                groupHeader.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
            }
        });

        $('#prev-month-btn').addEventListener('click', () => { displayedDate.setMonth(displayedDate.getMonth() - 1); renderCalendar(); });
        $('#next-month-btn').addEventListener('click', () => { displayedDate.setMonth(displayedDate.getMonth() + 1); renderCalendar(); });
        $('#calendar-grid').addEventListener('click', (e) => { const dayCell = e.target.closest('.day-cell'); if (dayCell && dayCell.dataset.date) { showRemindersForDate(dayCell.dataset.date); } });
        $('#dashboard').addEventListener('click', (e) => {
            const reminderButton = e.target.closest('.goto-reminder-btn');
            if (reminderButton && reminderButton.dataset.date) {
                displayedDate = new Date(reminderButton.dataset.date + 'T12:00:00');
                showPage('#month');
                return;
            }
            const card = e.target.closest('[data-target-page]');
            if (card && card.dataset.targetPage) {
                const targetPage = card.dataset.targetPage;
                showPage(targetPage);
            }
        });
        setupCrudListeners();
    }

    const recurringFormHtml = `
        <input type="text" name="name" placeholder="Descri√ß√£o (ex: Aluguel, Netflix)" class="w-full p-2 border rounded">
        <div class="grid grid-cols-2 gap-4">
            <input type="number" name="amount" placeholder="Valor" step="0.01" class="w-full p-2 border rounded">
            <input type="number" name="due_day" placeholder="Dia do Vencimento" min="1" max="31" class="w-full p-2 border rounded">
        </div>
        <input type="text" name="category" placeholder="Categoria (ex: Moradia, Assinaturas)" class="w-full p-2 border rounded">
        <div class="space-y-2 border p-3 rounded-md">
            <label class="block text-sm font-medium">Tipo:</label>
            <div class="flex gap-4">
                <label class="flex items-center gap-2"><input type="radio" name="type" value="expense" checked> Despesa</label>
                <label class="flex items-center gap-2"><input type="radio" name="type" value="income"> Receita</label>
            </div>
        </div>
         <div class="space-y-2 border p-3 rounded-md">
            <label class="block text-sm font-medium">Intervalo:</label>
             <select name="interval" class="w-full p-2 border rounded bg-white">
                <option value="monthly">Mensal</option>
            </select>
        </div>
    `;


    function setupCrudListeners() {
        
        $('#day').addEventListener('click', async (e) => {
            const target = e.target;
            const button = target.closest('button, input');
            if (target.id === 'add-day-task-btn') {
                if (!checkLogin()) return;
                openCrudModal({ title: 'Nova Tarefa', formHtml: `<input name="text" placeholder="Descri√ß√£o" class="w-full p-2 border rounded">`,
                    onSave: async (data) => { if (!data.text) return; await supabaseClient.from('day_tasks').insert({ text: data.text, profile_id: currentProfileId }); history.back(); await refreshDataAndRender(); }
                });
                return;
            }
            if (!button?.dataset.id) return;
            const id = button.dataset.id;
            if (button.matches('.day-task-check')) {
                const task = state.dayTasks.find(t => t.id == id);
                if(!task) return;

                const isCompleting = !task.completed;
                
                await supabaseClient.from('day_tasks').update({ 
                    completed: isCompleting,
                    completed_at: isCompleting ? new Date().toISOString() : null 
                }).eq('id', id);

            }
            else if (button.matches('.delete-day-task-btn')) {
                if(confirm('Tem certeza?')) {
                    await supabaseClient.from('day_tasks').delete().eq('id', id);
                } else { return; }
            } 
            else if (button.matches('.edit-day-task-btn')) {
                const task = state.dayTasks.find(t => t.id == id);
                openCrudModal({ title: 'Editar Tarefa', item: task, formHtml: `<input name="text" class="w-full p-2 border rounded">`,
                    onSave: async (data) => { if (!data.text) return; await supabaseClient.from('day_tasks').update({ text: data.text }).eq('id', id); history.back(); await refreshDataAndRender(); }
                });
                return; 



            } else if (button.matches('.add-day-subtask-btn')) {
                openCrudModal({ title: 'Nova Subtarefa', formHtml: `<input name="text" placeholder="Descri√ß√£o da subtarefa" class="w-full p-2 border rounded">`,
                    onSave: async (data) => {
                        if (!data.text) return;
                        await supabaseClient.from('day_subtasks').insert({ text: data.text, parent_task_id: id, profile_id: currentProfileId });
                        history.back(); await refreshDataAndRender();
                    }
                });
                return;
            } else if (button.matches('.delete-day-subtask-btn')) {
                await supabaseClient.from('day_subtasks').delete().eq('id', id);
            } else if (button.matches('.day-subtask-check')) {
                let subtaskToUpdate;
                for(const task of state.dayTasks) {
                    const found = task.day_subtasks.find(st => st.id == id);
                    if(found) { subtaskToUpdate = found; break; }
                }
                if (subtaskToUpdate) await supabaseClient.from('day_subtasks').update({ completed: !subtaskToUpdate.completed }).eq('id', id);
            } else if (button.matches('.edit-day-subtask-btn')) {
                const taskId = button.dataset.taskId;
                const task = state.dayTasks.find(t => t.id == taskId);
                const subtask = task.day_subtasks.find(st => st.id == id);
                openCrudModal({ title: 'Editar Subtarefa', item: subtask, formHtml: `<input name="text" class="w-full p-2 border rounded">`,
                    onSave: async (data) => {
                        if (!data.text) return;
                        await supabaseClient.from('day_subtasks').update({ text: data.text }).eq('id', id);
                        history.back(); await refreshDataAndRender();
                    }
                });
                return;
            }
            await refreshDataAndRender();
        });

        $('#add-highlight-btn').addEventListener('click', () => {
            if (!checkLogin()) return;
            openCrudModal({ title: 'Novo Destaque', formHtml: `<input name="text" placeholder="Destaque do dia" class="w-full p-2 border rounded">`,
                onSave: async (data) => {
                    if(!data.text) return;
                    await supabaseClient.from('day_highlights').insert({ text: data.text, profile_id: currentProfileId });
                    history.back(); await refreshDataAndRender();
                }
            });
        });
        $('#highlights-list').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button?.dataset.id) return;
            const id = button.dataset.id;
            if (button.matches('.delete-highlight-btn')) {
                await supabaseClient.from('day_highlights').delete().eq('id', id);
            } else if (button.matches('.edit-highlight-btn')) {
                const highlight = state.dayHighlights.find(h => h.id == id);
                openCrudModal({ title: 'Editar Destaque', item: highlight, formHtml: `<input name="text" class="w-full p-2 border rounded">`,
                    onSave: async (data) => {
                        if(!data.text) return;
                        await supabaseClient.from('day_highlights').update({ text: data.text }).eq('id', id);
                        history.back(); await refreshDataAndRender();
                    }
                });
                return;
            }
            await refreshDataAndRender();
        });


        $('#add-week-goal-btn').addEventListener('click', () => {
            if (!checkLogin()) return;
            openCrudModal({ title: 'Novo Objetivo Semanal', formHtml: `<input name="text" placeholder="Descri√ß√£o do objetivo" class="w-full p-2 border rounded">`,
                onSave: async (data) => { if(!data.text) return; await supabaseClient.from('week_goals').insert({ text: data.text, profile_id: currentProfileId }); history.back(); await refreshDataAndRender(); }
            });
        });
        $('#week-goals-list').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button?.dataset.id) return;
            const id = button.dataset.id;
            if (button.matches('.delete-week-goal-btn')) {
                await supabaseClient.from('week_goals').delete().eq('id', id);
            } else if (button.matches('.edit-week-goal-btn')) {
                const goal = state.weekGoals.find(g => g.id == id);
                openCrudModal({ title: 'Editar Objetivo', item: goal, formHtml: `<input name="text" class="w-full p-2 border rounded">`,
                    onSave: async (data) => { if(!data.text) return; await supabaseClient.from('week_goals').update({ text: data.text }).eq('id', id); history.back(); await refreshDataAndRender(); }
                });
                return;
            }
            await refreshDataAndRender();
        });

        $('#week').addEventListener('click', async (e) => {
            const target = e.target;
            const dayButton = target.closest('#week-day-selector button');
            if (dayButton) {
                state.selectedDayOfWeek = parseInt(dayButton.dataset.day, 10);
                renderWeeklyRoutine();
                return;
            }
            if (target.matches('.weekly-task-check')) {
                const taskId = target.dataset.taskId;
                const todayStr = new Date().toISOString().split('T')[0];
                if (target.checked) {
                    await supabaseClient.from('weekly_task_completions').insert({ task_id: taskId, profile_id: currentProfileId, completion_date: todayStr });
                } else {
                    await supabaseClient.from('weekly_task_completions').delete().match({ task_id: taskId, completion_date: todayStr });
                }
                await refreshDataAndRender();
            }
            const deleteBtn = target.closest('.delete-weekly-task-btn');
            if (deleteBtn) {
                const taskId = deleteBtn.dataset.taskId;
                await supabaseClient.from('weekly_routine_tasks').delete().eq('id', taskId);
                await refreshDataAndRender();
            }
        });
        $('#add-weekly-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = $('#new-weekly-task-input');
            const description = input.value.trim();
            if (description && state.selectedDayOfWeek !== undefined) {
                await supabaseClient.from('weekly_routine_tasks').insert({ description: description, day_of_week: state.selectedDayOfWeek, profile_id: currentProfileId });
                input.value = '';
                await refreshDataAndRender();
            }
        });


        const daysOfWeekOptions = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
        const habitFormHtml = `
            <input name="name" placeholder="Nome do H√°bito (ex: Treinar)" class="w-full p-2 border rounded">
            <div class="space-y-2 border p-3 rounded-md">
                <label class="block text-sm font-medium">Dias da Semana:</label>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                    ${daysOfWeekOptions.map((day, index) => `
                        <label class="flex items-center gap-2"><input type="checkbox" name="days_of_week" value="${index}" class="h-4 w-4 rounded">${day}</label>
                    `).join('')}
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium">Hor√°rio de In√≠cio (opcional):</label>
                    <input type="time" name="time" class="w-full p-2 border rounded">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium">Hor√°rio de T√©rmino (opcional):</label>
                    <input type="time" name="time_end" class="w-full p-2 border rounded">
                </div>
            </div>
        `;

        $('#add-weekly-habit-btn').addEventListener('click', () => {
            if (!checkLogin()) return;
            openCrudModal({
                title: 'Adicionar H√°bito Fixo', formHtml: habitFormHtml,
                onSave: async (data) => {
                    if (!data.name || !data.days_of_week) return alert('Nome e pelo menos um dia da semana s√£o obrigat√≥rios.');
                    const days = data.days_of_week.map(Number);
                    await supabaseClient.from('weekly_habits').insert({ 
                        name: data.name, 
                        days_of_week: days, 
                        time: data.time || null, 
                        time_end: data.time_end || null,
                        profile_id: currentProfileId 
                    });
                    history.back();
                    await refreshDataAndRender();
                }
            });
        });

        $('#add-weekly-habit-btn').addEventListener('click', () => {
            if (!checkLogin()) return;
            openCrudModal({
                title: 'Adicionar H√°bito Fixo', formHtml: habitFormHtml,
                onSave: async (data) => {
                    if (!data.name || !data.days_of_week) return alert('Nome e pelo menos um dia da semana s√£o obrigat√≥rios.');
                    const days = data.days_of_week.map(Number); // Converte os valores para n√∫meros
                    await supabaseClient.from('weekly_habits').insert({ name: data.name, days_of_week: days, time: data.time || null, profile_id: currentProfileId });
                    history.back();
                    await refreshDataAndRender();
                }
            });
        });

        $('#weekly-habits-list').addEventListener('click', async (e) => {
            const target = e.target;
            if(target.matches('.weekly-habit-check')) {
                const habitId = target.dataset.habitId;
                const date = target.dataset.date;
                if (target.checked) {
                    await supabaseClient.from('habit_completions').insert({ habit_id: habitId, profile_id: currentProfileId, completion_date: date });
                } else {
                    await supabaseClient.from('habit_completions').delete().match({ habit_id: habitId, completion_date: date });
                }
                await refreshDataAndRender();
            }

            const deleteBtn = target.closest('.delete-weekly-habit-btn');
            if (deleteBtn) {
                if(confirm('Tem certeza que deseja apagar este h√°bito?')) {
                    await supabaseClient.from('weekly_habits').delete().eq('id', deleteBtn.dataset.id);
                    await refreshDataAndRender();
                }
            }
            
            const editBtn = target.closest('.edit-weekly-habit-btn');
            if(editBtn) {
                const habit = state.weeklyHabits.find(h => h.id === editBtn.dataset.id);
                if(habit) {
                    openCrudModal({
                        title: 'Editar H√°bito Fixo', item: habit, formHtml: habitFormHtml,
                        onSave: async (data) => {
                             if (!data.name || !data.days_of_week) return alert('Nome e pelo menos um dia da semana s√£o obrigat√≥rios.');
                            const days = data.days_of_week.map(Number);
                            await supabaseClient.from('weekly_habits').update({ name: data.name, days_of_week: days, time: data.time || null }).eq('id', habit.id);
                            history.back();
                            await refreshDataAndRender();
                        }
                    });
                }
            }
        });

        $('#add-achievement-btn').addEventListener('click', () => {
            if (!checkLogin()) return;
            openCrudModal({ title: 'Nova Conquista', formHtml: `<input name="text" placeholder="Descri√ß√£o da conquista" class="w-full p-2 border rounded">`,
                onSave: async(data) => {
                    if(!data.text) return;
                    await supabaseClient.from('month_achievements').insert({ text: data.text, profile_id: currentProfileId });
                    history.back(); await refreshDataAndRender();
                }
            });
        });
        $('#achievements-list').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button?.dataset.id) return;
            const id = button.dataset.id;
            if (button.matches('.delete-achievement-btn')) {
                await supabaseClient.from('month_achievements').delete().eq('id', id);
            } else if (button.matches('.edit-achievement-btn')) {
                const achievement = state.monthAchievements.find(a => a.id == id);
                openCrudModal({ title: 'Editar Conquista', item: achievement, formHtml: `<input name="text" class="w-full p-2 border rounded">`,
                    onSave: async(data) => {
                        if(!data.text) return;
                        await supabaseClient.from('month_achievements').update({ text: data.text }).eq('id', id);
                        history.back(); await refreshDataAndRender();
                    }
                });
                return;
            }
            await refreshDataAndRender();
        });

        const transactionFormHtml = `<input type="text" name="description" placeholder="Descri√ß√£o" class="w-full p-2 border rounded"><input type="text" name="category" placeholder="Categoria" class="w-full p-2 border rounded"><input type="number" name="amount" placeholder="Valor" step="0.01" class="w-full p-2 border rounded">`;
        $('#add-income-btn').addEventListener('click', () => {
            if (!checkLogin()) return;
            openCrudModal({ title: 'Nova Receita', formHtml: transactionFormHtml,
                onSave: async (data) => {
                    if(!data.description || !data.amount) return;
                    await supabaseClient.from('transactions').insert({ ...data, type: 'income', profile_id: currentProfileId });
                    history.back(); await refreshDataAndRender();
                }
            });
        });
        $('#add-expense-btn').addEventListener('click', () => {
            if (!checkLogin()) return;
            openCrudModal({ title: 'Nova Despesa', formHtml: transactionFormHtml,
                onSave: async (data) => {
                    if(!data.description || !data.amount) return;
                    await supabaseClient.from('transactions').insert({ ...data, type: 'expense', profile_id: currentProfileId });
                    history.back(); await refreshDataAndRender();
                }
            });
        });
        $('#transactions-table-body').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button?.dataset.id) return;
            const id = button.dataset.id;
            if (button.matches('.delete-transaction-btn')) {
                await supabaseClient.from('transactions').delete().eq('id', id);
            } else if (button.matches('.edit-transaction-btn')) {
                const transaction = state.transactions.find(t => t.id == id);
                openCrudModal({ title: 'Editar Transa√ß√£o', item: transaction, formHtml: transactionFormHtml,
                    onSave: async (data) => {
                        if(!data.description || !data.amount) return;
                        await supabaseClient.from('transactions').update(data).eq('id', id);
                        history.back(); await refreshDataAndRender();
                    }
                });
                return;
            }
            await refreshDataAndRender();
        });
        
        $('#buy').addEventListener('click', async (e) => {
            const el = e.target.closest('button, input');
            if (!el) return;
            if (el.matches('.add-shopping-item-btn')) {
                if (!checkLogin()) return;
                const category = el.dataset.category;
                openCrudModal({ title: `Novo Item - ${category}`, formHtml: `<input name="text" placeholder="Nome do item" class="w-full p-2 border rounded">`,
                    onSave: async (data) => {
                        if(!data.text) return;
                        await supabaseClient.from('shopping_list').insert({ ...data, category, profile_id: currentProfileId });
                        history.back(); await refreshDataAndRender();
                    }
                });
                return;
            }
            if (el.id === 'add-shopping-category-btn') {
                 if (!checkLogin()) return;
                 openCrudModal({ title: 'Nova Categoria de Compras', formHtml: `<input name="name" placeholder="Nome da categoria" class="w-full p-2 border rounded">`,
                    onSave: async(data) => {
                        if (!data.name) return;
                        await supabaseClient.from('shopping_categories').insert({ name: data.name, profile_id: currentProfileId });
                        history.back(); await refreshDataAndRender();
                    }
                 });
                 return;
            }
            if (el.matches('.delete-shopping-category-btn')) {
                if(confirm('Tem certeza que deseja excluir esta categoria e todos os itens dentro dela?')) {
                    const categoryId = el.dataset.id;
                    const categoryToDelete = state.shoppingCategories.find(c => c.id === categoryId);
                    if(categoryToDelete) {
                        await supabaseClient.from('shopping_categories').delete().eq('id', categoryId);
                        await supabaseClient.from('shopping_list').delete().eq('category', categoryToDelete.name);
                        await refreshDataAndRender();
                    }
                }
                return;
            }
            if (!el.dataset.id) return;
            const id = el.dataset.id;
            if (el.matches('.delete-shopping-item-btn')) {
                await supabaseClient.from('shopping_list').delete().eq('id', id);
            } else if (el.matches('.shopping-item-check')) {
                const item = state.shoppingList.find(i => i.id == id);
                if (item) await supabaseClient.from('shopping_list').update({ completed: !item.completed }).eq('id', id);
            } else if (el.matches('.edit-shopping-item-btn')) {
                const item = state.shoppingList.find(i => i.id == id);
                openCrudModal({ title: 'Editar Item', item, formHtml: `<input name="text" class="w-full p-2 border rounded">`,
                    onSave: async(data) => {
                        if(!data.text) return;
                        await supabaseClient.from('shopping_list').update({text: data.text}).eq('id', id);
                        history.back(); await refreshDataAndRender();
                    }
                });
                return;
            }
            await refreshDataAndRender();
        });
       
        const todoFormHtml = `<input type="text" name="text" placeholder="Descri√ß√£o da tarefa" class="w-full p-2 border rounded"><select name="priority" class="w-full p-2 border rounded"><option value="baixa">Baixa</option><option value="media">M√©dia</option><option value="alta">Alta</option></select><select name="status" class="w-full p-2 border rounded"><option value="pendente">Pendente</option><option value="andamento">Em Andamento</option><option value="concluido">Conclu√≠do</option></select>`;
        $('#todo').addEventListener('click', async (e) => {
            const button = e.target.closest('button');

            if (button && button.id === 'add-todo-btn') {
                if (!checkLogin()) return;
                openCrudModal({ title: 'Nova Tarefa', formHtml: todoFormHtml,
                    onSave: async (data) => {
                        if(!data.text) return;
                        await supabaseClient.from('todos').insert({ ...data, profile_id: currentProfileId, completed_at: null });
                        history.back(); await refreshDataAndRender();
                    }
                });
                return;
            }
            
            if (!button?.dataset.id) return;
            const id = button.dataset.id;
            if (button.matches('.delete-todo-btn')) {
                if(confirm('Tem certeza?')) {
                    await supabaseClient.from('todos').delete().eq('id', id);
                    await refreshDataAndRender();
                }
            } 
            else if (button.matches('.edit-todo-btn')) {
                const todo = state.todos.find(t => t.id == id);
                if(!todo) return;
                
                openCrudModal({ title: 'Editar Tarefa', item: todo, formHtml: todoFormHtml,
                    onSave: async(data) => {
                        if(!data.text) return;
                        
                        const isCompleting = data.status === 'concluido' && todo.status !== 'concluido';
                        const isReopening = data.status !== 'concluido' && todo.status === 'concluido';

                        data.completed_at = isCompleting ? new Date().toISOString() : (isReopening ? null : todo.completed_at);

                        await supabaseClient.from('todos').update(data).eq('id', id);
                        history.back(); await refreshDataAndRender();
                    }
                });
            }
        });


        $('#add-recurring-btn').addEventListener('click', () => {
            if (!checkLogin()) return;
            openCrudModal({
                title: 'Nova Conta Recorrente', formHtml: recurringFormHtml,
                onSave: async (data) => {
                    if (!data.name || !data.amount || !data.due_day) return alert('Descri√ß√£o, valor e dia do vencimento s√£o obrigat√≥rios.');
                    await supabaseClient.from('recurring_transactions').insert({ ...data, profile_id: currentProfileId });
                    history.back();
                    await refreshDataAndRender();
                }
            });
        });

        $('#recurring-transactions-list').addEventListener('click', async (e) => {
            const target = e.target;
            const recurringId = target.dataset.id;
            if (!recurringId) return;
            
            const item = state.recurringTransactions.find(t => t.id === recurringId);
            if (!item) return;

            if (target.matches('.mark-as-paid-btn')) {
                await supabaseClient.from('transactions').insert({
                    description: item.name,
                    category: item.category,
                    amount: item.amount,
                    type: item.type,
                    profile_id: currentProfileId
                });

                await supabaseClient.from('recurring_transactions').update({ 
                    last_paid_date: new Date().toISOString() 
                }).eq('id', recurringId);

                await refreshDataAndRender();
            }
            if (target.matches('.delete-recurring-btn')) {
                if (confirm(`Tem certeza que deseja excluir a conta recorrente "${item.name}"?`)) {
                    await supabaseClient.from('recurring_transactions').delete().eq('id', recurringId);
                    await refreshDataAndRender();
                }
            }
            if (target.matches('.edit-recurring-btn')) {
                openCrudModal({
                    title: 'Editar Conta Recorrente', item: item, formHtml: recurringFormHtml,
                    onSave: async (data) => {
                        if (!data.name || !data.amount || !data.due_day) return alert('Descri√ß√£o, valor e dia do vencimento s√£o obrigat√≥rios.');
                        await supabaseClient.from('recurring_transactions').update(data).eq('id', recurringId);
                        history.back();
                        await refreshDataAndRender();
                    }
                });
            }
        });
    
        const goalFormHtml = `<input type="text" name="text" placeholder="Descri√ß√£o da meta" class="w-full p-2 border rounded"><select name="category" class="w-full p-2 border rounded"><option>Financeira</option><option>Sa√∫de</option><option>Estudos</option><option>Pessoal</option></select><input type="number" name="current" placeholder="Valor Atual" class="w-full p-2 border rounded" step="any"><input type="number" name="target" placeholder="Valor Alvo" class="w-full p-2 border rounded" step="any"><input type="text" name="unit" placeholder="Unidade (ex: R$, km, %)" class="w-full p-2 border rounded">`;
    
        let holdTimeout, holdInterval;
        const stopHolding = async (goalId) => { clearTimeout(holdTimeout); clearInterval(holdInterval); const goal = state.goals.find(g => g.id === goalId); if (goal) { await supabaseClient.from('goals').update({ current: goal.current }).eq('id', goalId); } };
        
        $('#goals').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            if(button.id === 'add-goal-btn') {
                if (!checkLogin()) return;
                openCrudModal({ title: 'Nova Meta', formHtml: goalFormHtml,
                    onSave: async (data) => { if(!data.text || !data.target) return; await supabaseClient.from('goals').insert({ ...data, profile_id: currentProfileId, completed_at: null }); history.back(); await refreshDataAndRender(); }
                });
                return;
            }

            if (!button.dataset.id) return;
            const id = button.dataset.id;
            
            if (button.matches('.complete-goal-btn')) {
                await supabaseClient.from('goals').update({ completed_at: new Date().toISOString() }).eq('id', id);
            }
            else if (button.matches('.uncomplete-goal-btn')) {
                await supabaseClient.from('goals').update({ completed_at: null, current: 0 }).eq('id', id);
            }
            else if (button.matches('.delete-goal-btn')) {
                if(confirm('Tem certeza?')) await supabaseClient.from('goals').delete().eq('id', id); else return;
            } 
            else if (button.matches('.edit-goal-btn')) {
                const goal = state.goals.find(g => g.id == id);
                openCrudModal({ title: 'Editar Meta', item: goal, formHtml: goalFormHtml,
                    onSave: async (data) => { if(!data.text || !data.target) return; await supabaseClient.from('goals').update(data).eq('id', id); history.back(); await refreshDataAndRender(); }
                });
                return;
            }
            await refreshDataAndRender();
        });

    
        const handleGoalAdjust = (goalId, action) => {
            const goal = state.goals.find(g => g.id === goalId); if (!goal) return;
            const updateGoal = (step) => { if (action === 'increment') { goal.current += step; } else if (action === 'decrement') { goal.current = Math.max(0, goal.current - step); } renderGoals(); };
            updateGoal(1);
            let currentStep = 1; let speed = 160;
            holdTimeout = setTimeout(() => {
                holdInterval = setInterval(() => {
                    if (speed < 70) { currentStep = 10; } else if (speed < 120) { currentStep = 5; } else { currentStep = 1; }
                    speed = Math.max(30, speed * 0.90);
                    updateGoal(currentStep);
                }, speed);
            }, 400);
            
            const stopAction = () => {
                clearTimeout(holdTimeout); clearInterval(holdInterval);
                document.removeEventListener('mouseup', stopAction); 
                document.removeEventListener('mouseleave', stopAction);
                document.removeEventListener('touchend', stopAction);
                document.removeEventListener('touchcancel', stopAction);
                stopHolding(goalId); 
            };
            
            document.addEventListener('mouseup', stopAction);
            document.addEventListener('mouseleave', stopAction);
            document.addEventListener('touchend', stopAction);
            document.addEventListener('touchcancel', stopAction);
        };
        const handleGoalDrag = (e) => {
            e.preventDefault();
            const progressBarContainer = e.target.closest('.progress-bar-container');
            if (!progressBarContainer) return;
            
            const goalId = progressBarContainer.dataset.id;
            const goal = state.goals.find(g => g.id === goalId);
            if (!goal || !goal.target) return;

            const handleDragMove = (moveEvent) => {
                const event = moveEvent.touches ? moveEvent.touches[0] : moveEvent; 
                const currentProgressBar = document.querySelector(`.progress-bar-container[data-id="${goalId}"]`);
                if (!currentProgressBar) return; 
                
                const rect = currentProgressBar.getBoundingClientRect();
                let offsetX = event.clientX - rect.left;
                offsetX = Math.max(0, Math.min(offsetX, rect.width));
                const newPercentage = rect.width > 0 ? (offsetX / rect.width) * 100 : 0;
                const newCurrent = (newPercentage / 100) * goal.target;
                goal.current = Math.round(newCurrent * 100) / 100; 
                renderGoals();
            };

            const handleDragEnd = async () => {
                document.removeEventListener('mousemove', handleDragMove);
                document.removeEventListener('mouseup', handleDragEnd);
                document.removeEventListener('touchmove', handleDragMove);
                document.removeEventListener('touchend', handleDragEnd);
                
                goal.current = Math.round(goal.current * 100) / 100;
                await supabaseClient.from('goals').update({ current: goal.current }).eq('id', goalId);
                renderGoals();
            };
            
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);
            document.addEventListener('touchmove', handleDragMove, { passive: true });
            document.addEventListener('touchend', handleDragEnd);
            
            handleDragMove(e);
        };

        const handleGoalInteractionStart = (e) => {
            const button = e.target.closest('.goal-adjust-btn');
            const progressBarContainer = e.target.closest('.progress-bar-container');
            
            if (button) {
                handleGoalAdjust(button.dataset.id, button.dataset.action);
            } else if (progressBarContainer) {
                handleGoalDrag(e);
            }
        };

        $('#goals-list').addEventListener('mousedown', handleGoalInteractionStart);
        $('#goals-list').addEventListener('touchstart', handleGoalInteractionStart, { passive: false });




    }

    // ===================================================================
    // 8. INICIALIZA√á√ÉO DA APLICA√á√ÉO
    // ===================================================================
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (event === 'PASSWORD_RECOVERY') {
                showUpdatePasswordModal();
            }
            else {
            refreshDataAndRender();
            }
        });
        setupEventListeners();
        await refreshDataAndRender();

        const initialHash = window.location.hash || '#dashboard';
        showPage(initialHash);


        window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredInstallPrompt = e;
        const installPwaBtn = $('#install-pwa-btn');
        if (installPwaBtn) {
            installPwaBtn.classList.remove('hidden');
        }
    });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('Service Worker registrado com sucesso:', registration.scope);
                }).catch(error => {
                    console.log('Falha ao registrar o Service Worker:', error);
                });
            });
        }
    });



</script>
</body>
</html>

